<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>OSLAPRINT | Paco</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales/es.global.min.js'></script>
    <style>
        :root { --osla-orange: #f37021; --osla-dark: #0a0a0a; --osla-card: #161616; }
        body { background-color: var(--osla-dark); color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; padding-bottom: 60px; }
        .navbar { background: #000; border-bottom: 2px solid var(--osla-orange); padding: 0.8rem 1rem; }
        .text-muted { color: #d1d1d1 !important; }
        .form-label, label { color: #f8f9fa !important; font-weight: 500; }
        .form-control, .form-select { background: #000 !important; border: 1px solid #444 !important; color: #fff !important; }
        .form-control:focus, .form-select:focus { border-color: var(--osla-orange) !important; box-shadow: none; }
        .nav-link { color: #d1d1d1; font-weight: 600; border: none !important; font-size: 0.9rem; }
        .nav-link.active { color: var(--osla-orange) !important; background: transparent !important; border-bottom: 3px solid var(--osla-orange) !important; }
        .table-dark { --bs-table-bg: #161616; color: #f1f1f1; border-radius: 10px; overflow: hidden; }
        .card-emp { background: var(--osla-card); border: 1px solid #333; border-radius: 15px; padding: 20px; text-align: center; position: relative; }
        .btn-delete-user { position: absolute; top: 10px; right: 10px; color: #dc3545; background: none; border: none; }
        #calendarAdmin, #calendarGlobal { background: #fff; color: #000; padding: 10px; border-radius: 10px; min-height: 500px; }
        .suggestions-list { position: absolute; top: 100%; left: 0; width: 100%; max-height: 200px; overflow-y: auto; background: #1f1f1f; border: 1px solid #444; border-radius: 0 0 8px 8px; z-index: 1050; display: none; }
        .suggestion-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #333; color: #fff; }
        .suggestion-item:hover { background: var(--osla-orange); color: white; }
        .btn-check:checked+.btn-outline-custom { color: white; border-width: 2px; opacity: 1; }
        .btn-outline-custom { color: #bbb; border-color: #555; opacity: 0.7; transition: all 0.2s; }
        .btn-outline-custom:hover { opacity: 1; filter: brightness(1.2); }
        .filter-group { background: #1f1f1f; padding: 15px; border-radius: 10px; border: 1px solid #333; }
        .client-support { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .client-support.active { background-color: #28a745; }
        .client-support.inactive { background-color: #dc3545; }
        .alarm-item { background: #1f1f1f; border-left: 4px solid #ffc107; padding: 12px; margin-bottom: 10px; border-radius: 4px; cursor: pointer; transition: all 0.2s; }
        .alarm-item:hover { background: #2a2a2a; }
        .alarm-item.read { opacity: 0.6; border-left-color: #6c757d; }
        .alarm-item.priority-high { border-left-color: #dc3545; }
        .alarm-item.priority-low { border-left-color: #28a745; }
        .list-view-item { background: #1f1f1f; border-left: 4px solid #444; padding: 12px; margin-bottom: 8px; border-radius: 4px; transition: all 0.2s; cursor: pointer; }
        .list-view-item:hover { background: #2a2a2a; }
        .modal-content { background-color: #1e1e1e; color: #fff; }
        .modal-header, .modal-footer { border-color: #333; }
        @media(max-width: 768px) { .nav-tabs { display: flex; justify-content: space-around; flex-wrap: wrap; } .nav-item { flex: 1 1 30%; text-align: center; font-size: 0.8em; } .fc-header-toolbar { flex-direction: column; font-size: 0.8em; } }
    </style>
</head>
<body>
    <nav class="navbar d-flex justify-content-between sticky-top">
        <span class="fw-bold fs-5 text-white">OSLA<span style="color:var(--osla-orange)">PRINT</span> <small class="badge bg-secondary ms-1" style="font-size: 0.6em;">PACO</small></span>
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-outline-warning btn-sm position-relative" data-bs-toggle="modal" data-bs-target="#modalAlarms" title="Alarmas">
                <i class="bi bi-bell-fill"></i>
                {% if unread_alarms_count > 0 %}
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">{{ unread_alarms_count }}</span>
                {% endif %}
            </button>
            <span class="text-white fw-bold me-2">Hola {{ current_user.username }}</span>
            <button class="btn btn-outline-light btn-sm" data-bs-toggle="modal" data-bs-target="#modalChangePassword" title="Cambiar Contraseña"><i class="bi bi-key-fill"></i></button>
            <a href="/logout" class="btn btn-outline-danger btn-sm"><i class="bi bi-power"></i></a>
        </div>
    </nav>

    <div class="container mt-3 pb-5">
        {% with messages = get_flashed_messages() %}
        {% if messages %}{% for m in messages %}<div class="alert alert-info py-2 small alert-dismissible fade show">{{ m }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>{% endfor %}{% endif %}
        {% endwith %}

        <ul class="nav nav-tabs mb-4 border-0 bg-dark sticky-top pt-2" style="top:55px; z-index:900;" role="tablist">
            <li class="nav-item"><button class="nav-link active w-100" data-bs-toggle="tab" data-bs-target="#team">EQUIPO</button></li>
            <li class="nav-item"><button class="nav-link w-100" data-bs-toggle="tab" data-bs-target="#global-agenda" id="tabGlobalBtn">AGENDA</button></li>
            <li class="nav-item"><button class="nav-link w-100" data-bs-toggle="tab" data-bs-target="#analytics">ANÁLISIS</button></li>
            <li class="nav-item"><button class="nav-link w-100" data-bs-toggle="tab" data-bs-target="#data">INFORMES</button></li>
            <li class="nav-item"><button class="nav-link w-100" data-bs-toggle="tab" data-bs-target="#stock">STOCK</button></li>
            <li class="nav-item"><button class="nav-link w-100" data-bs-toggle="tab" data-bs-target="#clients">CLIENTES</button></li>
            <li class="nav-item"><button class="nav-link w-100" data-bs-toggle="tab" data-bs-target="#config">CONFIG</button></li>
        </ul>

        <div class="tab-content">
            <!-- TAB: EQUIPO -->
            <div class="tab-pane fade show active" id="team">
                <div class="d-flex justify-content-between mb-3 align-items-center">
                    <h4 class="fw-bold text-white fs-5 m-0">Gestión de Equipo</h4>
                    <button class="btn btn-warning btn-sm fw-bold" data-bs-toggle="modal" data-bs-target="#modalAddUser">
                        <i class="bi bi-person-plus-fill me-1"></i> Nuevo Usuario
                    </button>
                </div>

                <div class="row g-3">
                    {% for u in empleados %}
                    <div class="col-12 col-sm-6 col-md-4">
                        <div class="card-emp">
                            <button class="btn-delete-user" data-bs-toggle="modal" data-user-id="{{ u.id }}"
                                onclick="document.getElementById('deleteUserId').value=this.dataset.userId;" data-bs-target="#modalDeleteUser">
                                <i class="bi bi-x-circle-fill fs-4"></i>
                            </button>
                            <i class="bi bi-person-circle fs-1 mb-2 text-warning"></i>
                            <h5 class="mb-1 text-white fw-bold">{{ u.username }}</h5>
                            <small class="text-muted">ID: #{{ u.id }}</small>
                            <hr class="my-3" style="border-color:#333;">
                            <button class="btn btn-sm btn-primary w-100 mb-2" onclick="loadEmployeeCalendar({{ u.id }}, '{{ u.username }}')">
                                <i class="bi bi-calendar-check-fill me-1"></i> Ver Calendario
                            </button>
                            <button class="btn btn-sm btn-info w-100" onclick="loadTechStats({{ u.id }}, '{{ u.username }}')">
                                <i class="bi bi-bar-chart-fill me-1"></i> Ver Análisis
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div id="calendarAdminContainer" class="mt-4" style="display:none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="text-white fw-bold m-0" id="empCalendarTitle">Calendario de Empleado</h5>
                        <div>
                            <button class="btn btn-sm btn-success me-2" data-bs-toggle="modal" data-bs-target="#modalAddTaskFromCalendar">
                                <i class="bi bi-plus-circle me-1"></i> Añadir Cita
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="closeEmployeeCalendar()">
                                <i class="bi bi-x-circle me-1"></i> Cerrar
                            </button>
                        </div>
                    </div>
                    <div id="calendarAdmin"></div>
                </div>
            </div>

            <!-- TAB: AGENDA GLOBAL -->
            <div class="tab-pane fade" id="global-agenda">
                <div class="d-flex justify-content-between mb-3 align-items-center flex-wrap">
                    <h4 class="fw-bold text-white fs-5 m-0">Agenda Global de Tareas</h4>
                    <button class="btn btn-warning btn-sm fw-bold" data-bs-toggle="modal" data-bs-target="#modalScheduleAppointment">
                        <i class="bi bi-calendar-plus-fill me-1"></i> Nueva Cita
                    </button>
                </div>

                <!-- FILTROS DINÁMICOS -->
                <div class="filter-group mb-3">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <small class="text-muted fw-bold d-block mb-2">FILTRAR POR TÉCNICO</small>
                            <select id="filterTech" class="form-select form-select-sm" onchange="updateGlobalFilters()">
                                <option value="all">Todos los técnicos</option>
                                {% for u in empleados %}
                                <option value="{{ u.id }}">{{ u.username }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <small class="text-muted fw-bold d-block mb-2">FILTRAR POR CLIENTE</small>
                            <input type="text" id="filterClient" class="form-control form-control-sm" placeholder="Nombre del cliente" onkeyup="updateGlobalFilters()">
                        </div>
                        <div class="col-md-4 mb-3">
                            <small class="text-muted fw-bold d-block mb-2">TIPO DE SERVICIO</small>
                            <select id="filterService" class="form-select form-select-sm" onchange="updateGlobalFilters()">
                                <option value="all">Todos los servicios</option>
                                {% for svc in all_service_types %}
                                <option value="{{ svc.name }}">{{ svc.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted fw-bold">FILTRAR POR TIPO (CLICK PARA ACTIVAR/DESACTIVAR)</small>
                        <button class="btn btn-outline-light btn-sm" onclick="checkAllFilters()">
                            <i class="bi bi-check-all me-1"></i> Todos
                        </button>
                    </div>
                    <div class="btn-group-sm d-flex flex-wrap gap-2 mt-2" role="group">
                        {% for svc in all_service_types %}
                        <input type="checkbox" class="btn-check filter-cb" id="filter-{{ svc.id }}" value="{{ svc.name }}" checked onchange="updateGlobalFilters()">
                        <label class="btn btn-outline-custom flex-grow-1" for="filter-{{ svc.id }}" style="border-color: {{ svc.color }}; color: {{ svc.color }};">
                            {{ svc.name }}
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- BOTONES DE VISTA -->
                <div class="btn-group mb-3" role="group">
                    <button type="button" class="btn btn-outline-info btn-sm active" id="btnViewMonth" onclick="changeCalendarView('dayGridMonth')">
                        <i class="bi bi-calendar-month me-1"></i> Mes
                    </button>
                    <button type="button" class="btn btn-outline-info btn-sm" id="btnViewWeek" onclick="changeCalendarView('timeGridWeek')">
                        <i class="bi bi-calendar-week me-1"></i> Semana
                    </button>
                    <button type="button" class="btn btn-outline-info btn-sm" id="btnViewDay" onclick="changeCalendarView('timeGridDay')">
                        <i class="bi bi-calendar-day me-1"></i> Día
                    </button>
                    <button type="button" class="btn btn-outline-info btn-sm" id="btnViewList" onclick="toggleListView()">
                        <i class="bi bi-list-ul me-1"></i> Lista
                    </button>
                </div>

                <div id="calendarGlobal"></div>
                <div id="listViewContainer" style="display:none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="text-white fw-bold m-0">Vista de Lista</h5>
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleListView()">
                            <i class="bi bi-calendar me-1"></i> Volver a Calendario
                        </button>
                    </div>
                    <div id="listViewContent"></div>
                </div>
            </div>

            <!-- TAB: ANÁLISIS INDIVIDUAL -->
            <div class="tab-pane fade" id="analytics">
                <h4 class="fw-bold text-white fs-5 mb-3">Análisis Individual de Trabajadores</h4>
                
                <div class="row g-3 mb-4">
                    {% for u in empleados %}
                    <div class="col-12 col-md-6 col-lg-4">
                        <div class="card bg-dark border-secondary">
                            <div class="card-body">
                                <h5 class="card-title text-warning">
                                    <i class="bi bi-person-circle me-2"></i>{{ u.username.upper() }}
                                </h5>
                                <button class="btn btn-sm btn-outline-info w-100" onclick="loadTechStats({{ u.id }}, '{{ u.username }}')">
                                    <i class="bi bi-bar-chart-fill me-1"></i> Ver Estadísticas Completas
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div id="techStatsContainer" class="d-none">
                    <div class="card bg-dark border-warning">
                        <div class="card-header bg-warning text-dark">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="m-0"><i class="bi bi-graph-up me-2"></i><span id="statsName">Trabajador</span></h5>
                                <button class="btn btn-sm btn-dark" onclick="closeTechStats()">
                                    <i class="bi bi-x-circle"></i> Cerrar
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="text-center p-3 bg-black rounded">
                                        <div class="text-muted small">Trabajos Completados</div>
                                        <div class="fs-3 fw-bold text-success" id="statsTotal">0</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-center p-3 bg-black rounded">
                                        <div class="text-muted small">Horas Totales</div>
                                        <div class="fs-3 fw-bold text-info" id="statsHours">0h</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-center p-3 bg-black rounded">
                                        <div class="text-muted small">Tipos de Servicio</div>
                                        <div class="fs-3 fw-bold text-warning" id="statsServices">0</div>
                                    </div>
                                </div>
                            </div>
                            <h6 class="text-white fw-bold mb-3">
                                <i class="bi bi-pie-chart-fill me-2"></i>Desglose por Tipo de Servicio
                            </h6>
                            <div id="serviceBreakdown"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: INFORMES -->
            <div class="tab-pane fade" id="data">
                <div class="d-flex justify-content-between mb-3">
                    <h4 class="fw-bold text-white fs-5 m-0">Informes de Trabajo Completados</h4>
                </div>
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Técnico</th>
                                <th>Cliente</th>
                                <th>Servicio</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in informes %}
                            <tr>
                                <td>{{ r.date.strftime('%d/%m/%Y') }}</td>
                                <td>{{ r.tech.username if r.tech else 'N/A' }}</td>
                                <td>{{ r.client_name }}</td>
                                <td><span class="badge" style="background-color: {{ dict([(s.name, s.color) for s in all_service_types]).get(r.service_type, '#6c757d') }}">{{ r.service_type }}</span></td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="viewTaskDetails({{ r.id }})">
                                        <i class="bi bi-eye-fill"></i> Ver
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TAB: STOCK -->
            <div class="tab-pane fade" id="stock">
                <div class="d-flex justify-content-between mb-3">
                    <h4 class="fw-bold text-white fs-5 m-0">Gestión de Inventario</h4>
                    <button class="btn btn-warning btn-sm fw-bold" data-bs-toggle="modal" data-bs-target="#modalAddStock">
                        <i class="bi bi-plus-circle-fill me-1"></i> Nuevo Producto
                    </button>
                </div>
                
                <div class="accordion" id="accordionStock">
                    {% set categories = {} %}
                    {% for item in inventory %}
                        {% set _ = categories.update({item.category: categories.get(item.category, []) + [item]}) if item.category else None %}
                    {% endfor %}
                    
                    {% for category, items in categories.items() %}
                    <div class="accordion-item bg-dark border-secondary">
                        <h2 class="accordion-header">
                            <button class="accordion-button bg-dark text-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}">
                                <i class="bi bi-box-seam me-2"></i>{{ category or 'Sin Categoría' }} ({{ items|length }})
                            </button>
                        </h2>
                        <div id="collapse{{ loop.index }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}">
                            <div class="accordion-body">
                                {% set subcats = {} %}
                                {% for item in items %}
                                    {% set _ = subcats.update({item.subcategory or 'General': subcats.get(item.subcategory or 'General', []) + [item]}) %}
                                {% endfor %}
                                
                                {% for subcat, subitems in subcats.items() %}
                                <h6 class="text-warning mt-2 mb-2"><i class="bi bi-tag me-1"></i>{{ subcat }}</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-dark">
                                        <thead>
                                            <tr>
                                                <th>Producto</th>
                                                <th>Cantidad</th>
                                                <th>Stock Mínimo</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in subitems %}
                                            <tr {% if item.quantity <= item.min_stock %}class="table-danger"{% endif %}>
                                                <td>{{ item.name }}</td>
                                                <td>
                                                    <span class="badge {% if item.quantity <= item.min_stock %}bg-danger{% else %}bg-success{% endif %}">
                                                        {{ item.quantity }}
                                                    </span>
                                                </td>
                                                <td>{{ item.min_stock }}</td>
                                                <td>
                                                    <button class="btn btn-sm btn-warning" onclick="editStockItem({{ item.id }}, '{{ item.name }}', '{{ item.category }}', '{{ item.subcategory }}', {{ item.quantity }}, {{ item.min_stock }})">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-danger" onclick="deleteStockItem({{ item.id }}, '{{ item.name }}')">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- TAB: CLIENTES -->
            <div class="tab-pane fade" id="clients">
                <div class="d-flex justify-content-between mb-3">
                    <h4 class="fw-bold text-white fs-5 m-0">Base de Datos de Clientes</h4>
                    <button class="btn btn-warning btn-sm fw-bold" data-bs-toggle="modal" data-bs-target="#modalAddClient">
                        <i class="bi bi-person-plus-fill me-1"></i> Nuevo Cliente
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>Estado</th>
                                <th>Cliente</th>
                                <th>Teléfono</th>
                                <th>Email</th>
                                <th>Dirección</th>
                                <th>Soporte</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for c in clients %}
                            <tr>
                                <td>
                                    <span class="client-support {% if c.has_support %}active{% else %}inactive{% endif %}" title="{% if c.has_support %}Con soporte técnico{% else %}Sin soporte técnico{% endif %}"></span>
                                </td>
                                <td><strong>{{ c.name }}</strong></td>
                                <td>{{ c.phone }}</td>
                                <td>{{ c.email }}</td>
                                <td>
                                    <a href="https://www.google.com/maps/search/?api=1&query={{ c.address|urlencode }}" target="_blank" class="text-info">
                                        <i class="bi bi-geo-alt-fill me-1"></i>{{ c.address[:30] }}...
                                    </a>
                                </td>
                                <td>
                                    {% if c.has_support %}
                                    <div class="small">
                                        {% if c.support_monday_friday %}<span class="badge bg-success">L-V</span>{% endif %}
                                        {% if c.support_saturday %}<span class="badge bg-warning">S</span>{% endif %}
                                        {% if c.support_sunday %}<span class="badge bg-danger">D</span>{% endif %}
                                    </div>
                                    {% else %}
                                    <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="viewClientDetails({{ c.id }})">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-warning" onclick="editClient({{ c.id }})">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TAB: CONFIGURACIÓN -->
            <div class="tab-pane fade" id="config">
                <h4 class="fw-bold text-white fs-5 mb-4">Configuración del Sistema</h4>
                
                <div class="card bg-dark border-secondary mb-3">
                    <div class="card-header">
                        <h6 class="mb-0 text-white"><i class="bi bi-palette me-2"></i>Tipos de Servicio y Colores</h6>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-warning btn-sm mb-3" data-bs-toggle="modal" data-bs-target="#modalAddService">
                            <i class="bi bi-plus-circle me-1"></i> Añadir Tipo
                        </button>
                        <div class="table-responsive">
                            <table class="table table-dark">
                                <thead>
                                    <tr>
                                        <th>Tipo de Servicio</th>
                                        <th>Color</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for s in services %}
                                    <tr>
                                        <td>{{ s.name }}</td>
                                        <td><span class="badge" style="background-color: {{ s.color }}">{{ s.color }}</span></td>
                                        <td>
                                            <button class="btn btn-sm btn-warning" onclick="editService({{ s.id }}, '{{ s.name }}', '{{ s.color }}')">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteService({{ s.id }}, '{{ s.name }}')">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALES -->
    
    <!-- Modal: Cambiar Contraseña -->
    <div class="modal fade" id="modalChangePassword" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Cambiar Contraseña</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/change_password">
                    <div class="modal-body">
                        <label class="form-label">Contraseña Actual</label>
                        <input type="password" name="current_password" class="form-control mb-2" required>
                        <label class="form-label">Nueva Contraseña</label>
                        <input type="password" name="new_password" class="form-control mb-2" required>
                        <label class="form-label">Confirmar Nueva Contraseña</label>
                        <input type="password" name="confirm_password" class="form-control" required>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="submit" class="btn btn-warning">Cambiar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Añadir Usuario -->
    <div class="modal fade" id="modalAddUser" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Crear Nuevo Usuario</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/manage_users">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="add">
                        <label class="form-label">Nombre de Usuario</label>
                        <input type="text" name="username" class="form-control mb-2" required>
                        <label class="form-label">Contraseña</label>
                        <input type="password" name="password" class="form-control mb-2" required>
                        <label class="form-label">Rol</label>
                        <select name="role" class="form-select">
                            <option value="tech">Técnico</option>
                            <option value="admin">Administrador</option>
                        </select>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="submit" class="btn btn-warning">Crear</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Eliminar Usuario -->
    <div class="modal fade" id="modalDeleteUser" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-danger">Confirmar Eliminación</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/manage_users">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="delete">
                        <input type="hidden" name="user_id" id="deleteUserId">
                        <p>¿Estás seguro de que deseas eliminar este usuario?</p>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger">Eliminar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Programar Cita -->
    <div class="modal fade" id="modalScheduleAppointment" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Nueva Cita</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/manage_task">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="add">
                        <div class="mb-3">
                            <label class="form-label">Técnico Asignado</label>
                            <select name="tech_id" class="form-select" required>
                                {% for u in empleados %}
                                <option value="{{ u.id }}">{{ u.username }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3 position-relative">
                            <label class="form-label">Cliente</label>
                            <input type="text" name="client_name" id="appointmentClient" class="form-control" required placeholder="Buscar cliente..." autocomplete="off" oninput="searchClients(this, 'appointmentClientList')">
                            <div id="appointmentClientList" class="suggestions-list"></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Fecha</label>
                            <input type="date" name="date" class="form-control" required>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">Hora Inicio</label>
                                <input type="time" name="start_time" class="form-control" required>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">Hora Fin</label>
                                <input type="time" name="end_time" class="form-control">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tipo de Servicio</label>
                            <select name="service_type" class="form-select" required>
                                {% for s in all_service_types %}
                                <option value="{{ s.name }}">{{ s.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descripción</label>
                            <textarea name="description" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="submit" class="btn btn-warning">Crear Cita</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Añadir Tarea desde Calendario de Empleado -->
    <div class="modal fade" id="modalAddTaskFromCalendar" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Añadir Cita al Técnico</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/manage_task">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="add">
                        <input type="hidden" name="tech_id" id="addTaskTechId">
                        <div class="mb-3 position-relative">
                            <label class="form-label">Cliente</label>
                            <input type="text" name="client_name" id="addTaskClient" class="form-control" required placeholder="Buscar cliente..." autocomplete="off" oninput="searchClients(this, 'addTaskClientList')">
                            <div id="addTaskClientList" class="suggestions-list"></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Fecha</label>
                            <input type="date" name="date" class="form-control" required>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">Hora Inicio</label>
                                <input type="time" name="start_time" class="form-control" required>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">Hora Fin</label>
                                <input type="time" name="end_time" class="form-control">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tipo de Servicio</label>
                            <select name="service_type" class="form-select" required>
                                {% for s in all_service_types %}
                                <option value="{{ s.name }}">{{ s.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descripción</label>
                            <textarea name="description" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="submit" class="btn btn-success">Añadir Cita</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Ver Detalles de Tarea -->
    <div class="modal fade" id="modalActionAdmin" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title"><i class="bi bi-info-circle me-2"></i>Detalles de la Tarea</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-2"><strong>Cliente:</strong> <span id="evtClient"></span></div>
                        <div class="col-md-6 mb-2"><strong>Técnico:</strong> <span id="evtTech"></span></div>
                        <div class="col-md-6 mb-2"><strong>Servicio:</strong> <span id="evtService"></span></div>
                        <div class="col-md-6 mb-2"><strong>Estado:</strong> <span id="evtStatus"></span></div>
                        <div class="col-12 mb-2"><strong>Descripción:</strong> <p id="evtDesc" class="text-muted"></p></div>
                    </div>
                    <div id="attachmentsSection" style="display:none;">
                        <hr>
                        <h6 class="text-warning"><i class="bi bi-paperclip me-1"></i>Archivos Adjuntos</h6>
                        <div id="attachmentsList"></div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Añadir Producto Stock -->
    <div class="modal fade" id="modalAddStock" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Añadir Producto al Stock</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/manage_stock">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="add">
                        <div class="mb-3">
                            <label class="form-label">Nombre del Producto</label>
                            <input type="text" name="name" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Categoría</label>
                            <select name="category" class="form-select" required>
                                <option value="Copiadoras">Copiadoras</option>
                                <option value="Cajones">Cajones</option>
                                <option value="TPV">TPV</option>
                                <option value="Consumibles">Consumibles</option>
                                <option value="Otros">Otros</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Subcategoría (opcional)</label>
                            <select name="subcategory" class="form-select">
                                <option value="">General</option>
                                <option value="Cashlogy">Cashlogy</option>
                                <option value="Cashkeeper">Cashkeeper</option>
                                <option value="ATCA">ATCA</option>
                                <option value="Canon">Canon</option>
                                <option value="HP">HP</option>
                                <option value="Epson">Epson</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">Cantidad Inicial</label>
                                <input type="number" name="quantity" class="form-control" value="0" required>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">Stock Mínimo</label>
                                <input type="number" name="min_stock" class="form-control" value="5" required>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="submit" class="btn btn-warning">Añadir</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Editar Stock -->
    <div class="modal fade" id="modalEditStock" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Editar Producto</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/manage_stock">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="edit">
                        <input type="hidden" name="item_id" id="editStockId">
                        <div class="mb-3">
                            <label class="form-label">Nombre del Producto</label>
                            <input type="text" name="name" id="editStockName" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Categoría</label>
                            <select name="category" id="editStockCategory" class="form-select" required>
                                <option value="Copiadoras">Copiadoras</option>
                                <option value="Cajones">Cajones</option>
                                <option value="TPV">TPV</option>
                                <option value="Consumibles">Consumibles</option>
                                <option value="Otros">Otros</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Subcategoría</label>
                            <input type="text" name="subcategory" id="editStockSubcategory" class="form-control">
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">Cantidad</label>
                                <input type="number" name="quantity" id="editStockQuantity" class="form-control" required>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">Stock Mínimo</label>
                                <input type="number" name="min_stock" id="editStockMinStock" class="form-control" required>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="submit" class="btn btn-warning">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Eliminar Stock -->
    <div class="modal fade" id="modalDeleteStock" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-danger">Confirmar Eliminación</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/manage_stock">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="delete">
                        <input type="hidden" name="item_id" id="deleteStockId">
                        <p>¿Estás seguro de eliminar <strong id="deleteStockName"></strong>?</p>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger">Eliminar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Añadir Cliente -->
    <div class="modal fade" id="modalAddClient" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Nuevo Cliente</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/manage_clients">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="add">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Nombre del Cliente <span class="text-danger">*</span></label>
                                <input type="text" name="name" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Teléfono <span class="text-danger">*</span></label>
                                <input type="tel" name="phone" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email <span class="text-danger">*</span></label>
                                <input type="email" name="email" class="form-control" required>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Dirección <span class="text-danger">*</span></label>
                                <input type="text" name="address" class="form-control" placeholder="Calle, número, ciudad" required>
                                <small class="text-muted">Se creará enlace a Google Maps automáticamente</small>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Notas Internas</label>
                                <textarea name="notes" class="form-control" rows="2" placeholder="Comentarios internos sobre el cliente"></textarea>
                            </div>
                            <div class="col-md-12 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="has_support" id="addClientSupport" onchange="toggleSupportOptions('addClientSupport', 'addSupportOptions')">
                                    <label class="form-check-label" for="addClientSupport">
                                        Cliente con Soporte Técnico Contratado
                                    </label>
                                </div>
                            </div>
                            <div id="addSupportOptions" class="col-md-12 d-none">
                                <div class="card bg-black p-3">
                                    <h6 class="text-warning mb-2">Cobertura del Soporte:</h6>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="support_monday_friday" id="addSupportLV">
                                        <label class="form-check-label" for="addSupportLV">Lunes a Viernes</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="support_saturday" id="addSupportS">
                                        <label class="form-check-label" for="addSupportS">Sábados</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="support_sunday" id="addSupportD">
                                        <label class="form-check-label" for="addSupportD">Domingos</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="submit" class="btn btn-warning">Añadir Cliente</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Editar Cliente -->
    <div class="modal fade" id="modalEditClient" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Editar Cliente</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/manage_clients">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="edit">
                        <input type="hidden" name="client_id" id="editClientId">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Nombre del Cliente <span class="text-danger">*</span></label>
                                <input type="text" name="name" id="editClientName" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Teléfono <span class="text-danger">*</span></label>
                                <input type="tel" name="phone" id="editClientPhone" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email <span class="text-danger">*</span></label>
                                <input type="email" name="email" id="editClientEmail" class="form-control" required>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Dirección <span class="text-danger">*</span></label>
                                <input type="text" name="address" id="editClientAddress" class="form-control" required>
                            </div>
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Notas Internas</label>
                                <textarea name="notes" id="editClientNotes" class="form-control" rows="2"></textarea>
                            </div>
                            <div class="col-md-12 mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="has_support" id="editClientSupport" onchange="toggleSupportOptions('editClientSupport', 'editSupportOptions')">
                                    <label class="form-check-label" for="editClientSupport">
                                        Cliente con Soporte Técnico Contratado
                                    </label>
                                </div>
                            </div>
                            <div id="editSupportOptions" class="col-md-12 d-none">
                                <div class="card bg-black p-3">
                                    <h6 class="text-warning mb-2">Cobertura del Soporte:</h6>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="support_monday_friday" id="editSupportLV">
                                        <label class="form-check-label" for="editSupportLV">Lunes a Viernes</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="support_saturday" id="editSupportS">
                                        <label class="form-check-label" for="editSupportS">Sábados</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="support_sunday" id="editSupportD">
                                        <label class="form-check-label" for="editSupportD">Domingos</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="submit" class="btn btn-warning">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Ver Detalles de Cliente -->
    <div class="modal fade" id="modalViewClient" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title"><i class="bi bi-person-circle me-2"></i><span id="viewClientName"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong><i class="bi bi-telephone me-2"></i>Teléfono:</strong><br>
                            <span id="viewClientPhone"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong><i class="bi bi-envelope me-2"></i>Email:</strong><br>
                            <span id="viewClientEmail"></span>
                        </div>
                        <div class="col-md-12 mb-3">
                            <strong><i class="bi bi-geo-alt me-2"></i>Dirección:</strong><br>
                            <a href="#" id="viewClientMapLink" target="_blank" class="text-info"></a>
                        </div>
                        <div class="col-md-12 mb-3">
                            <strong><i class="bi bi-chat-left-text me-2"></i>Notas:</strong><br>
                            <p id="viewClientNotes" class="text-muted"></p>
                        </div>
                        <div class="col-md-12">
                            <strong><i class="bi bi-shield-check me-2"></i>Soporte Técnico:</strong><br>
                            <span id="viewClientSupport"></span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Añadir Tipo de Servicio -->
    <div class="modal fade" id="modalAddService" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Nuevo Tipo de Servicio</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/manage_services">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="add">
                        <label class="form-label">Nombre</label>
                        <input type="text" name="name" class="form-control mb-2" required>
                        <label class="form-label">Color (Hex)</label>
                        <input type="color" name="color" class="form-control" value="#6c757d" required>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="submit" class="btn btn-warning">Añadir</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Editar Tipo de Servicio -->
    <div class="modal fade" id="modalEditService" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Editar Tipo de Servicio</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/manage_services">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="edit">
                        <input type="hidden" name="service_id" id="editServiceId">
                        <label class="form-label">Nombre</label>
                        <input type="text" name="name" id="editServiceName" class="form-control mb-2" required>
                        <label class="form-label">Color (Hex)</label>
                        <input type="color" name="color" id="editServiceColor" class="form-control" required>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="submit" class="btn btn-warning">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Eliminar Servicio -->
    <div class="modal fade" id="modalDeleteService" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-danger">Confirmar Eliminación</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/manage_services">
                    <div class="modal-body">
                        <input type="hidden" name="action" value="delete">
                        <input type="hidden" name="service_id" id="deleteServiceId">
                        <p>¿Estás seguro de eliminar <strong id="deleteServiceName"></strong>?</p>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-danger">Eliminar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Alarmas -->
    <div class="modal fade" id="modalAlarms" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-warning">
                        <i class="bi bi-bell-fill me-2"></i>Sistema de Alarmas y Avisos
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <button class="btn btn-sm btn-warning mb-3" data-bs-toggle="modal" data-bs-target="#modalCreateAlarm">
                        <i class="bi bi-plus-circle me-1"></i> Crear Alarma
                    </button>

                    <div id="alarmsList">
                        {% for alarm in alarms %}
                        <div class="alarm-item {% if alarm.is_read %}read{% endif %} priority-{{ alarm.priority }}"
                             onclick="markAlarmRead({{ alarm.id }})">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="text-white mb-1">
                                        {% if alarm.alarm_type == 'technical' %}
                                        <i class="bi bi-tools me-1"></i>
                                        {% elif alarm.alarm_type == 'maintenance' %}
                                        <i class="bi bi-wrench me-1"></i>
                                        {% elif alarm.alarm_type == 'low_stock' %}
                                        <i class="bi bi-box-seam me-1"></i>
                                        {% endif %}
                                        {{ alarm.title }}
                                    </h6>
                                    <p class="text-muted small mb-1">{{ alarm.description }}</p>
                                    {% if alarm.client_name %}
                                    <small class="text-info">
                                        <i class="bi bi-person me-1"></i>{{ alarm.client_name }}
                                    </small>
                                    {% endif %}
                                </div>
                                <small class="text-muted">{{ alarm.created_at.strftime('%d/%m %H:%M') }}</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Crear Alarma -->
    <div class="modal fade" id="modalCreateAlarm" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="POST" action="/create_alarm">
                    <div class="modal-header border-secondary">
                        <h5 class="modal-title text-warning">Nueva Alarma</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Tipo de Alarma</label>
                            <select name="alarm_type" class="form-select" required>
                                <option value="technical">Incidencia Técnica</option>
                                <option value="maintenance">Mantenimiento</option>
                                <option value="low_stock">Stock Bajo</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Título</label>
                            <input type="text" name="title" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descripción</label>
                            <textarea name="description" class="form-control" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Cliente (Opcional)</label>
                            <input type="text" name="client_name" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Prioridad</label>
                            <select name="priority" class="form-select">
                                <option value="low">Baja</option>
                                <option value="normal" selected>Normal</option>
                                <option value="high">Alta</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-warning">Crear Alarma</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales
        let globalCalendar = null;
        let adminCalendar = null;
        let currentEmployeeTechId = null;
        let currentFilters = {
            tech: 'all',
            client: '',
            service: 'all',
            types: []
        };

        // Inicializar filtros de tipos
        document.addEventListener('DOMContentLoaded', function() {
            const filterCheckboxes = document.querySelectorAll('.filter-cb');
            filterCheckboxes.forEach(cb => {
                if(cb.checked) {
                    currentFilters.types.push(cb.value);
                }
            });
        });

        // Funciones de Calendario
        function initGlobalCalendar() {
            const calendarEl = document.getElementById('calendarGlobal');
            globalCalendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'es',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: function(info, successCallback, failureCallback) {
                    let url = `/api/events?tech=${currentFilters.tech}&service=${currentFilters.service}&client=${encodeURIComponent(currentFilters.client)}`;
                    fetch(url)
                        .then(res => res.json())
                        .then(events => {
                            // Filtrar por tipos seleccionados
                            const filtered = events.filter(e => currentFilters.types.includes(e.extendedProps.service_type));
                            successCallback(filtered);
                        })
                        .catch(err => failureCallback(err));
                },
                eventClick: function(info) {
                    viewTaskDetails(info.event.id);
                },
                height: 'auto'
            });
            globalCalendar.render();
        }

        function loadEmployeeCalendar(userId, username) {
            currentEmployeeTechId = userId;
            document.getElementById('addTaskTechId').value = userId;
            document.getElementById('empCalendarTitle').innerText = `Calendario de ${username.toUpperCase()}`;
            document.getElementById('calendarAdminContainer').style.display = 'block';

            if (adminCalendar) {
                adminCalendar.destroy();
            }

            const calendarEl = document.getElementById('calendarAdmin');
            adminCalendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                locale: 'es',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: `/api/events?tech=${userId}`,
                eventClick: function(info) {
                    viewTaskDetails(info.event.id);
                },
                height: 'auto'
            });
            adminCalendar.render();
        }

        function closeEmployeeCalendar() {
            document.getElementById('calendarAdminContainer').style.display = 'none';
            if (adminCalendar) {
                adminCalendar.destroy();
                adminCalendar = null;
            }
        }

        function updateGlobalFilters() {
            currentFilters.tech = document.getElementById('filterTech').value;
            currentFilters.client = document.getElementById('filterClient').value;
            currentFilters.service = document.getElementById('filterService').value;
            
            currentFilters.types = [];
            document.querySelectorAll('.filter-cb:checked').forEach(cb => {
                currentFilters.types.push(cb.value);
            });

            if (globalCalendar) {
                globalCalendar.refetchEvents();
            }
        }

        function checkAllFilters() {
            document.querySelectorAll('.filter-cb').forEach(cb => cb.checked = true);
            updateGlobalFilters();
        }

        function changeCalendarView(viewName) {
            if (globalCalendar) {
                globalCalendar.changeView(viewName);
            }
            // Update button states
            document.querySelectorAll('#btnViewMonth, #btnViewWeek, #btnViewDay').forEach(btn => {
                btn.classList.remove('active');
            });
            if(viewName === 'dayGridMonth') document.getElementById('btnViewMonth').classList.add('active');
            if(viewName === 'timeGridWeek') document.getElementById('btnViewWeek').classList.add('active');
            if(viewName === 'timeGridDay') document.getElementById('btnViewDay').classList.add('active');
        }

        function toggleListView() {
            const calendarDiv = document.getElementById('calendarGlobal');
            const listDiv = document.getElementById('listViewContainer');
            
            if (listDiv.style.display === 'none') {
                calendarDiv.style.display = 'none';
                listDiv.style.display = 'block';
                loadListView();
            } else {
                calendarDiv.style.display = 'block';
                listDiv.style.display = 'none';
            }
        }

        function loadListView() {
            let url = `/api/events?tech=${currentFilters.tech}&service=${currentFilters.service}&client=${encodeURIComponent(currentFilters.client)}`;
            fetch(url)
                .then(res => res.json())
                .then(events => {
                    const filtered = events.filter(e => currentFilters.types.includes(e.extendedProps.service_type));
                    const listContent = document.getElementById('listViewContent');
                    listContent.innerHTML = '';

                    if (filtered.length === 0) {
                        listContent.innerHTML = '<div class="alert alert-info">No hay tareas que mostrar</div>';
                        return;
                    }

                    // Agrupar por fecha
                    const grouped = {};
                    filtered.forEach(event => {
                        const date = event.start.split('T')[0];
                        if (!grouped[date]) grouped[date] = [];
                        grouped[date].push(event);
                    });

                    // Ordenar fechas
                    const sortedDates = Object.keys(grouped).sort();

                    sortedDates.forEach(date => {
                        const dateObj = new Date(date);
                        const formattedDate = dateObj.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                        
                        listContent.innerHTML += `<h6 class="text-warning mt-3 mb-2">${formattedDate}</h6>`;
                        
                        grouped[date].forEach(event => {
                            const time = event.start.includes('T') ? event.start.split('T')[1].substring(0,5) : 'Todo el día';
                            listContent.innerHTML += `
                                <div class="list-view-item" style="border-left-color: ${event.color}" onclick="viewTaskDetails(${event.id})">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="text-white mb-1">${event.title}</h6>
                                            <small class="text-muted">
                                                <i class="bi bi-clock me-1"></i>${time} | 
                                                <i class="bi bi-person me-1"></i>${event.extendedProps.tech_name} | 
                                                <span class="badge badge-sm" style="background-color: ${event.color}">${event.extendedProps.status}</span>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    });
                });
        }

        function viewTaskDetails(taskId) {
            fetch(`/api/task_details/${taskId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const t = data.data;
                        document.getElementById('evtClient').innerText = t.client_name;
                        document.getElementById('evtTech').innerText = t.tech_name;
                        document.getElementById('evtService').innerText = t.service_type;
                        document.getElementById('evtStatus').innerText = t.status;
                        document.getElementById('evtDesc').innerText = t.description || 'Sin descripción';
                        
                        // Mostrar archivos adjuntos si existen
                        const attachmentsSection = document.getElementById('attachmentsSection');
                        const attachmentsList = document.getElementById('attachmentsList');
                        
                        if (t.attachments && t.attachments.length > 0) {
                            attachmentsSection.style.display = 'block';
                            attachmentsList.innerHTML = t.attachments.map(file => `
                                <div class="mb-2">
                                    <a href="/download_attachment/${file}" target="_blank" class="text-info">
                                        <i class="bi bi-file-earmark me-1"></i>${file}
                                    </a>
                                </div>
                            `).join('');
                        } else {
                            attachmentsSection.style.display = 'none';
                        }
                        
                        const modal = new bootstrap.Modal(document.getElementById('modalActionAdmin'));
                        modal.show();
                    }
                });
        }

        // Funciones de Stock
        function editStockItem(id, name, category, subcategory, quantity, minStock) {
            document.getElementById('editStockId').value = id;
            document.getElementById('editStockName').value = name;
            document.getElementById('editStockCategory').value = category;
            document.getElementById('editStockSubcategory').value = subcategory || '';
            document.getElementById('editStockQuantity').value = quantity;
            document.getElementById('editStockMinStock').value = minStock;
            new bootstrap.Modal(document.getElementById('modalEditStock')).show();
        }

        function deleteStockItem(id, name) {
            document.getElementById('deleteStockId').value = id;
            document.getElementById('deleteStockName').innerText = name;
            new bootstrap.Modal(document.getElementById('modalDeleteStock')).show();
        }

        // Funciones de Clientes
        function viewClientDetails(clientId) {
            // Buscar cliente en la tabla
            fetch(`/api/clients?q=`)
                .then(res => res.json())
                .then(clients => {
                    const client = clients.find(c => c.id === clientId);
                    if (client) {
                        document.getElementById('viewClientName').innerText = client.name;
                        document.getElementById('viewClientPhone').innerText = client.phone;
                        document.getElementById('viewClientEmail').innerText = client.email;
                        document.getElementById('viewClientMapLink').innerText = client.address;
                        document.getElementById('viewClientMapLink').href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(client.address)}`;
                        document.getElementById('viewClientNotes').innerText = client.notes || 'Sin notas';
                        
                        const supportText = client.has_support ? '<span class="badge bg-success">Con soporte técnico</span>' : '<span class="badge bg-danger">Sin soporte técnico</span>';
                        document.getElementById('viewClientSupport').innerHTML = supportText;
                        
                        new bootstrap.Modal(document.getElementById('modalViewClient')).show();
                    }
                });
        }

        function editClient(clientId) {
            fetch(`/api/clients?q=`)
                .then(res => res.json())
                .then(clients => {
                    const client = clients.find(c => c.id === clientId);
                    if (client) {
                        document.getElementById('editClientId').value = client.id;
                        document.getElementById('editClientName').value = client.name;
                        document.getElementById('editClientPhone').value = client.phone;
                        document.getElementById('editClientEmail').value = client.email;
                        document.getElementById('editClientAddress').value = client.address;
                        document.getElementById('editClientNotes').value = client.notes || '';
                        document.getElementById('editClientSupport').checked = client.has_support;
                        
                        if (client.has_support) {
                            document.getElementById('editSupportOptions').classList.remove('d-none');
                        }
                        
                        new bootstrap.Modal(document.getElementById('modalEditClient')).show();
                    }
                });
        }

        function toggleSupportOptions(checkboxId, optionsId) {
            const checkbox = document.getElementById(checkboxId);
            const options = document.getElementById(optionsId);
            options.classList.toggle('d-none', !checkbox.checked);
        }

        // Autocomplete de Clientes
        function searchClients(input, listId) {
            const query = input.value;
            const listElement = document.getElementById(listId);
            
            if (query.length < 2) {
                listElement.style.display = 'none';
                return;
            }
            
            fetch(`/api/clients?q=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(clients => {
                    if (clients.length === 0) {
                        listElement.style.display = 'none';
                        return;
                    }
                    
                    listElement.innerHTML = '';
                    clients.forEach(client => {
                        const item = document.createElement('div');
                        item.className = 'suggestion-item';
                        item.innerHTML = `
                            <strong>${client.name}</strong><br>
                            <small class="text-muted">${client.phone} | ${client.email}</small>
                        `;
                        item.onclick = function() {
                            input.value = client.name;
                            listElement.style.display = 'none';
                        };
                        listElement.appendChild(item);
                    });
                    
                    listElement.style.display = 'block';
                });
        }

        // Cerrar sugerencias al hacer click fuera
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.position-relative')) {
                document.querySelectorAll('.suggestions-list').forEach(list => {
                    list.style.display = 'none';
                });
            }
        });

        // Funciones de Servicios
        function editService(id, name, color) {
            document.getElementById('editServiceId').value = id;
            document.getElementById('editServiceName').value = name;
            document.getElementById('editServiceColor').value = color;
            new bootstrap.Modal(document.getElementById('modalEditService')).show();
        }

        function deleteService(id, name) {
            if (confirm(`¿Estás seguro de eliminar el tipo de servicio "${name}"?`)) {
                document.getElementById('deleteServiceId').value = id;
                document.getElementById('deleteServiceName').innerText = name;
                document.querySelector('#modalDeleteService form').submit();
            }
        }

        // Funciones de Análisis
        function loadTechStats(techId, techName) {
            document.getElementById('statsName').textContent = techName.toUpperCase();
            document.getElementById('techStatsContainer').classList.remove('d-none');

            fetch(`/api/tech_stats/${techId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('statsTotal').textContent = data.data.total_completed;
                        document.getElementById('statsHours').textContent = data.data.total_hours + 'h';
                        document.getElementById('statsServices').textContent = Object.keys(data.data.service_breakdown).length;

                        const breakdown = document.getElementById('serviceBreakdown');
                        breakdown.innerHTML = '';

                        for (const [service, info] of Object.entries(data.data.service_breakdown)) {
                            const serviceCard = `
                                <div class="card bg-black border-secondary mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0 text-white">
                                            <i class="bi bi-tag-fill me-2"></i>${service} 
                                            <span class="badge bg-primary float-end">${info.count} trabajos</span>
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="list-group">
                                            ${info.tasks.map(task => `
                                                <div class="list-group-item bg-dark text-white border-secondary">
                                                    <div class="d-flex justify-content-between">
                                                        <div>
                                                            <strong>${task.client}</strong><br>
                                                            <small class="text-muted">${task.time}</small>
                                                        </div>
                                                        <small class="text-muted">${task.date}</small>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            `;
                            breakdown.innerHTML += serviceCard;
                        }
                    }
                });
        }

        function closeTechStats() {
            document.getElementById('techStatsContainer').classList.add('d-none');
        }

        // Funciones de Alarmas
        function markAlarmRead(alarmId) {
            fetch(`/mark_alarm_read/${alarmId}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    }
                });
        }

        // Inicializar calendario global cuando se abre la pestaña
        document.getElementById('tabGlobalBtn').addEventListener('click', function() {
            setTimeout(() => {
                if (!globalCalendar) {
                    initGlobalCalendar();
                }
            }, 100);
        });
    </script>
</body>
</html>
