<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>OSLAPRINT | Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <style>
        :root { --osla-orange: #f37021; --osla-dark: #0a0a0a; --osla-card: #161616; }
        body { background-color: var(--osla-dark); color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; padding-bottom: 60px; }
        .navbar { background: #000; border-bottom: 2px solid var(--osla-orange); padding: 0.8rem 1rem; }
        
        .text-muted { color: #d1d1d1 !important; }
        .form-label, label { color: #f8f9fa !important; font-weight: 500; }
        .nav-link { color: #d1d1d1; font-weight: 600; border: none !important; font-size: 0.9rem; }
        .nav-link.active { color: var(--osla-orange) !important; background: transparent !important; border-bottom: 3px solid var(--osla-orange) !important; }
        .table-dark { --bs-table-bg: #161616; color: #f1f1f1; border-radius: 10px; overflow: hidden; }
        .card-emp { background: var(--osla-card); border: 1px solid #333; border-radius: 15px; padding: 20px; text-align: center; }
        #calendarAdmin { background: #fff; color: #000; padding: 10px; border-radius: 10px; min-height: 400px; }
        
        /* Mobile overrides */
        @media(max-width: 768px) {
            .nav-tabs { display: flex; justify-content: space-around; }
            .nav-item { flex: 1; text-align: center; }
            .fc-header-toolbar { flex-direction: column; font-size: 0.8em; }
        }
    </style>
</head>
<body>

<nav class="navbar d-flex justify-content-between sticky-top">
    <span class="fw-bold fs-5 text-white">OSLA<span style="color:var(--osla-orange)">PRINT</span> <small class="badge bg-secondary ms-1" style="font-size: 0.6em;">ADMIN</small></span>
    <div class="d-flex align-items-center gap-2">
        <span class="text-white fw-bold me-2">Hola {{ current_user.username }}!</span>
        <a href="/logout" class="btn btn-outline-danger btn-sm"><i class="bi bi-power"></i></a>
    </div>
</nav>

<div class="container mt-3 pb-5">
    {% with messages = get_flashed_messages() %}
        {% if messages %}{% for m in messages %}<div class="alert alert-info py-2 small">{{ m }}</div>{% endfor %}{% endif %}
    {% endwith %}

    <ul class="nav nav-tabs mb-4 border-0 bg-dark sticky-top pt-2" style="top:55px; z-index:900;" role="tablist">
        <li class="nav-item"><button class="nav-link active w-100" data-bs-toggle="tab" data-bs-target="#team">EQUIPO</button></li>
        <li class="nav-item"><button class="nav-link w-100" data-bs-toggle="tab" data-bs-target="#data">INFORMES</button></li>
        <li class="nav-item"><button class="nav-link w-100" data-bs-toggle="tab" data-bs-target="#stock">STOCK</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="team">
            <div class="row g-3">
                {% for emp in empleados %}
                <div class="col-12 col-md-4">
                    <div class="card-emp shadow-sm">
                        <div class="d-flex align-items-center justify-content-center gap-3 mb-3">
                            <i class="bi bi-person-badge-fill fs-1 text-warning"></i>
                            <h4 class="fw-bold text-white m-0">{{ emp.username|upper }}</h4>
                        </div>
                        <button class="btn btn-outline-warning w-100 py-2" onclick="verAgenda('{{ emp.id }}', '{{ emp.username }}')">
                            <i class="bi bi-calendar3 me-2"></i>Gestionar Agenda
                        </button>
                    </div>
                </div>
                {% else %}<div class="col-12 text-center py-5 text-muted">No hay técnicos registrados.</div>{% endfor %}
            </div>
        </div>

        <div class="tab-pane fade" id="data">
            <div class="table-responsive">
                <table class="table table-dark table-hover align-middle small text-nowrap">
                    <thead><tr><th>Fecha</th><th>Técnico</th><th>Cliente</th><th>Detalles</th><th>Acción</th></tr></thead>
                    <tbody>
                        {% for inf in informes %}
                        <tr>
                            <td>{{ inf.date.strftime('%d/%m') }}</td>
                            <td class="text-white fw-bold">{{ inf.tech.username }}</td>
                            <td>
                                <div class="fw-bold text-warning text-truncate" style="max-width: 120px;">{{ inf.client_name }}</div>
                                <small class="d-block">{{ inf.service_type }}</small>
                            </td>
                            <td><div class="text-truncate" style="max-width: 150px;">{{ inf.description }}</div></td>
                            <td><a href="/print_report/{{ inf.id }}" target="_blank" class="btn btn-sm btn-light"><i class="bi bi-printer"></i></a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="stock">
            <div class="d-flex justify-content-between mb-3 align-items-center">
                <h4 class="fw-bold text-white fs-5 m-0">Inventario</h4>
                <button class="btn btn-success btn-sm px-3" data-bs-toggle="modal" data-bs-target="#modalAddStock"><i class="bi bi-plus-lg"></i> Item</button>
            </div>
            <div class="table-responsive">
                <table class="table table-dark table-hover align-middle small">
                    <thead><tr><th>Item</th><th class="d-none d-sm-table-cell">Cat.</th><th class="text-center">Cant.</th><th class="text-end">Gestión</th></tr></thead>
                    <tbody>
                        {% for item in inventory %}
                        <tr>
                            <td>
                                <div class="fw-bold text-white">{{ item.name }}</div>
                                <small class="d-block d-sm-none text-muted">{{ item.category }}</small>
                            </td>
                            <td class="d-none d-sm-table-cell">{{ item.category }}</td>
                            <td class="text-center fs-5 text-warning">{{ item.quantity }}</td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-warning mb-1" 
                                        onclick="openEditStockModal('{{item.id}}', '{{item.name}}', '{{item.category}}', '{{item.quantity}}')">
                                    <i class="bi bi-pencil-fill"></i>
                                </button>
                                
                                <button class="btn btn-sm btn-outline-light mb-1" onclick="ajustarStock('{{ item.id }}', '{{ item.name }}')">+/-</button>
                                
                                <form action="/manage_stock" method="POST" class="d-inline">
                                    <input type="hidden" name="action" value="delete">
                                    <input type="hidden" name="item_id" value="{{ item.id }}">
                                    <button class="btn btn-sm btn-outline-danger ms-1 mb-1"><i class="bi bi-trash"></i></button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalCale" tabindex="-1">
    <div class="modal-dialog modal-xl modal-fullscreen-lg-down">
        <div class="modal-content bg-dark border-warning p-0">
            <div class="modal-header border-bottom border-secondary py-2">
                <h6 class="text-white m-0">Agenda: <span id="techName" class="text-warning"></span></h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="row g-0">
                    <div class="col-lg-8 border-bottom border-lg-end border-secondary p-2 bg-white order-2 order-lg-1">
                        <div id="calendarAdmin"></div>
                    </div>
                    <div class="col-lg-4 p-3 order-1 order-lg-2 bg-dark">
                        <h5 class="text-warning mb-3">Nueva Cita</h5>
                        <form action="/schedule_appointment" method="POST">
                            <input type="hidden" name="tech_id" id="formTechId">
                            <div class="mb-2"><input type="text" name="client_name" class="form-control" placeholder="Cliente" required></div>
                            <div class="row g-2 mb-2">
                                <div class="col-7"><input type="date" name="date" class="form-control" required></div>
                                <div class="col-5"><input type="time" name="time" class="form-control"></div>
                            </div>
                            <div class="mb-2"><select name="service_type" class="form-select"><option>Revisión</option><option>Instalación</option><option>Urgencia</option></select></div>
                            <div class="mb-3"><textarea name="notes" class="form-control" rows="2" placeholder="Notas..."></textarea></div>
                            <button type="submit" class="btn btn-warning w-100 fw-bold">AGENDAR</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEventActionAdmin" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border-secondary text-white">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title">Gestionar Cita</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h5 id="evtClient" class="text-warning fw-bold"></h5>
                <span id="evtStatus" class="badge mb-3"></span>
                <p class="small text-muted border p-2 rounded border-secondary bg-black" id="evtDesc"></p>
                <input type="hidden" id="evtId">
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="performAdminTaskAction('delete')">Eliminar</button>
                <button type="button" class="btn btn-success btn-sm" id="btnCompleteAdmin" onclick="performAdminTaskAction('complete')">Marcar Hecha</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalAddStock" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <form action="/manage_stock" method="POST" class="modal-content bg-dark border-success">
            <div class="modal-header border-0"><h5 class="text-white">Nuevo Artículo</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="hidden" name="action" value="add">
                <div class="mb-3"><label class="form-label">Nombre</label><input name="name" class="form-control" required></div>
                <div class="mb-3"><label class="form-label">Categoría</label><select name="category" class="form-select"><option>Consumible</option><option>Pieza</option></select></div>
                <div class="mb-3"><label class="form-label">Cant. Inicial</label><input type="number" name="quantity" class="form-control" value="1" required></div>
            </div>
            <div class="modal-footer border-0"><button type="submit" class="btn btn-success w-100">Guardar</button></div>
        </form>
    </div>
</div>

<div class="modal fade" id="modalEditStock" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <form action="/manage_stock" method="POST" class="modal-content bg-dark border-warning">
            <div class="modal-header border-0"><h5 class="text-white">Editar Producto</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="hidden" name="action" value="edit_full">
                <input type="hidden" name="item_id" id="editFullId">
                <div class="mb-3"><label class="form-label">Nombre</label><input name="name" id="editFullName" class="form-control" required></div>
                <div class="mb-3"><label class="form-label">Categoría</label><select name="category" id="editFullCat" class="form-select"><option>Consumible</option><option>Pieza</option></select></div>
                <div class="mb-3"><label class="form-label">Cantidad (Total)</label><input type="number" name="quantity" id="editFullQty" class="form-control" required></div>
            </div>
            <div class="modal-footer border-0"><button type="submit" class="btn btn-warning w-100">Guardar Cambios</button></div>
        </form>
    </div>
</div>

<div class="modal fade" id="modalAdjustStock" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <form action="/manage_stock" method="POST" class="modal-content bg-dark border-info">
            <div class="modal-header border-0"><h5 class="text-white">Ajustar: <span id="adjName" class="text-info"></span></h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="hidden" name="action" value="update"><input type="hidden" name="item_id" id="adjId">
                <label class="form-label">Variación (+/-)</label><input type="number" name="quantity" class="form-control" placeholder="Ej: -1 para restar" required>
            </div>
            <div class="modal-footer border-0"><button type="submit" class="btn btn-info w-100">Aplicar</button></div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let calendar;
    const modalActionAdmin = new bootstrap.Modal(document.getElementById('modalEventActionAdmin'));

    function verAgenda(id, name) {
        document.getElementById('techName').innerText = name.toUpperCase();
        document.getElementById('formTechId').value = id;
        const modal = new bootstrap.Modal(document.getElementById('modalCale'));
        modal.show();
        
        document.getElementById('modalCale').addEventListener('shown.bs.modal', function () {
            if (calendar) calendar.destroy();
            var calendarEl = document.getElementById('calendarAdmin');
            // Mobile Optimization for Admin Calendar
            var isMobile = window.innerWidth < 992; // Use LG breakpoint for admin modal
            
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: isMobile ? 'listWeek' : 'dayGridMonth', 
                locale: 'es',
                headerToolbar: { 
                    left: 'prev,next', 
                    center: 'title', 
                    right: isMobile ? 'today' : 'dayGridMonth,listWeek' 
                },
                height: isMobile ? 350 : 500,
                events: '/api/admin/tasks/' + id,
                
                eventClick: function(info) {
                    const props = info.event.extendedProps;
                    document.getElementById('evtId').value = info.event.id;
                    document.getElementById('evtClient').innerText = props.client;
                    document.getElementById('evtDesc').innerText = props.desc;
                    
                    const statusSpan = document.getElementById('evtStatus');
                    statusSpan.innerText = props.status;
                    const btnComplete = document.getElementById('btnCompleteAdmin');
                    
                    if(props.status === 'Completado') {
                        statusSpan.className = 'badge bg-success';
                        btnComplete.style.display = 'none';
                    } else {
                        statusSpan.className = 'badge bg-primary';
                        btnComplete.style.display = 'inline-block';
                    }
                    modalActionAdmin.show();
                }
            });
            calendar.render();
        }, { once: true });
    }
    
    function performAdminTaskAction(action) {
        const id = document.getElementById('evtId').value;
        if(!confirm('¿Confirmar acción administrativa?')) return;

        fetch(`/api/task_action/${id}/${action}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if(data.success) {
                calendar.refetchEvents();
                modalActionAdmin.hide();
            } else {
                alert('Error: ' + data.msg);
            }
        });
    }

    function ajustarStock(id, name) {
        document.getElementById('adjId').value = id;
        document.getElementById('adjName').innerText = name;
        new bootstrap.Modal(document.getElementById('modalAdjustStock')).show();
    }

    function openEditStockModal(id, name, category, qty) {
        document.getElementById('editFullId').value = id;
        document.getElementById('editFullName').value = name;
        document.getElementById('editFullCat').value = category;
        document.getElementById('editFullQty').value = qty;
        new bootstrap.Modal(document.getElementById('modalEditStock')).show();
    }
</script>
</body>
</html>