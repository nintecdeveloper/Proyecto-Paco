<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>PACO ERP - Hostelería & SAT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body class="bg-slate-50 flex h-screen overflow-hidden text-slate-800">

    <aside class="w-64 bg-slate-900 text-white flex flex-col shadow-2xl">
        <div class="p-6 text-2xl font-black tracking-tighter text-blue-400">PACO ERP</div>
        <nav class="flex-1 px-4 space-y-2">
            <button onclick="showSection('hosteleria')"
                class="w-full flex items-center p-3 hover:bg-slate-800 rounded-xl transition group">
                <i class="fas fa-utensils mr-3 text-slate-400 group-hover:text-blue-400"></i> Hostelería
            </button>
            <button onclick="showSection('sat')"
                class="w-full flex items-center p-3 hover:bg-slate-800 rounded-xl transition group">
                <i class="fas fa-tools mr-3 text-slate-400 group-hover:text-orange-400"></i> Gestión SAT
            </button>
        </nav>
    </aside>

    <main class="flex-1 overflow-y-auto p-8">

        <section id="sec-hosteleria">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold">Inventario de Cocina</h1>
                <button onclick="toggleModal('modal-ing', true)"
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 shadow-lg transition">
                    + NUEVO INGREDIENTE
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-blue-500">
                    <p class="text-xs font-bold text-slate-400 uppercase">Alertas Stock</p>
                    <p id="dash-alerts" class="text-3xl font-black text-slate-800">0</p>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-green-500">
                    <p class="text-xs font-bold text-slate-400 uppercase">Total Ingredientes</p>
                    <p id="dash-total" class="text-3xl font-black text-slate-800">0</p>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 border-b">
                        <tr>
                            <th class="p-4 text-xs font-bold text-slate-500 uppercase">Nombre</th>
                            <th class="p-4 text-xs font-bold text-slate-500 uppercase">Stock</th>
                            <th class="p-4 text-xs font-bold text-slate-500 uppercase">Estado</th>
                        </tr>
                    </thead>
                    <tbody id="ing-table" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </section>

        <section id="sec-sat" class="hidden">
            <h1 class="text-3xl font-bold mb-6">Gestión de Técnicos (SAT)</h1>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 space-y-4">
                    <h2 class="text-sm font-bold text-slate-400 uppercase tracking-wider">Tareas Asignadas</h2>
                    <div id="lista-tareas" class="space-y-3">
                    </div>
                </div>

                <div class="lg:col-span-2 bg-white p-8 rounded-3xl shadow-sm border border-slate-100">
                    <h2 class="text-xl font-bold mb-6 flex items-center">
                        <i class="fas fa-file-signature mr-3 text-blue-500"></i> Parte de Trabajo Digital
                    </h2>
                    <form id="form-parte" class="space-y-6">
                        <input type="hidden" id="order-id">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Descripción de la
                                Reparación</label>
                            <textarea id="summary" rows="4"
                                class="w-full bg-slate-50 border p-4 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="¿Qué has arreglado y qué piezas has usado?"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Horas
                                    dedicadas</label>
                                <input type="number" id="time_spent" step="0.5"
                                    class="w-full bg-slate-50 border p-4 rounded-2xl outline-none"
                                    placeholder="Ej: 2.5">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Estado
                                    Final</label>
                                <select id="status-final"
                                    class="w-full bg-slate-50 border p-4 rounded-2xl outline-none">
                                    <option value="Realizado">Finalizado</option>
                                    <option value="Pendiente">Pendiente (Volveré)</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit"
                            class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl hover:bg-blue-600 transition shadow-lg">
                            Cerrar y Firmar Parte
                        </button>
                    </form>
                </div>
            </div>
        </section>
    </main>

    <div id="modal-ing"
        class="fixed inset-0 bg-slate-900/50 hidden backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden">
            <div class="p-6 border-b bg-slate-50 flex justify-between">
                <h3 class="font-bold">Añadir al ERP</h3>
                <button onclick="toggleModal('modal-ing', false)" class="text-slate-400">&times;</button>
            </div>
            <form id="form-ing" class="p-6 space-y-4">
                <input type="text" id="name" placeholder="Nombre"
                    class="w-full border p-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-500" required>
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="unit" placeholder="Unidad (Kg, Ud)"
                        class="border p-3 rounded-xl outline-none" required>
                    <input type="number" id="stock" placeholder="Stock Inicial"
                        class="border p-3 rounded-xl outline-none" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="min_stock" placeholder="Stock Mínimo"
                        class="border p-3 rounded-xl outline-none" required>
                    <input type="number" id="cost_per_unit" step="0.01" placeholder="Coste €"
                        class="border p-3 rounded-xl outline-none" required>
                </div>
                <button type="submit"
                    class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl hover:bg-blue-700 transition">GUARDAR
                    REGISTRO</button>
            </form>
        </div>
    </div>

    <script>
        function toggleModal(id, show) { document.getElementById(id).classList.toggle('hidden', !show); }

        function showSection(section) {
            document.getElementById('sec-hosteleria').classList.add('hidden');
            document.getElementById('sec-sat').classList.add('hidden');
            document.getElementById('sec-' + section).classList.remove('hidden');
        }

        async function loadData() {
            const [resIng, resDash] = await Promise.all([fetch('/ingredients'), fetch('/dashboard/alerts')]);
            const ings = await resIng.json();
            const dash = await resDash.json();

            document.getElementById('dash-alerts').innerText = dash.low_stock_count;
            document.getElementById('dash-total').innerText = dash.total_ingredients;

            const body = document.getElementById('ing-table');
            body.innerHTML = ings.map(i => `
                <tr class="hover:bg-slate-50 transition">
                    <td class="p-4 font-bold text-slate-700">${i.name}</td>
                    <td class="p-4 text-slate-600">${i.stock} ${i.unit}</td>
                    <td class="p-4">
                        <span class="px-3 py-1 rounded-full text-[10px] font-black uppercase ${i.stock <= i.min_stock ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}">
                            ${i.stock <= i.min_stock ? 'Bajo Stock' : 'OK'}
                        </span>
                    </td>
                </tr>`).join('');
        }

        document.getElementById('form-ing').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                name: document.getElementById('name').value,
                unit: document.getElementById('unit').value,
                stock: parseFloat(document.getElementById('stock').value),
                min_stock: parseFloat(document.getElementById('min_stock').value),
                cost_per_unit: parseFloat(document.getElementById('cost_per_unit').value)
            };

            const res = await fetch('/ingredients', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) { toggleModal('modal-ing', false); loadData(); e.target.reset(); }
        });

        window.onload = loadData;

        // Función para cargar las órdenes de trabajo
        async function loadWorkOrders() {
            const res = await fetch('/work-orders');
            const orders = await res.json();
            const container = document.getElementById('lista-tareas');

            container.innerHTML = orders.map(order => `
        <div onclick="selectOrder(${order.id}, '${order.client_name}')" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 cursor-pointer hover:border-blue-500 transition">
            <div class="flex justify-between items-start">
                <span class="text-xs font-bold px-2 py-1 rounded bg-blue-50 text-blue-600">${order.status}</span>
                <span class="text-xs text-slate-400">${order.date}</span>
            </div>
            <p class="font-bold mt-2 text-slate-800">${order.client_name}</p>
            <p class="text-xs text-slate-500 mt-1">${order.description}</p>
        </div>
    `).join('');
        }

        // Al hacer clic en una tarea, se pone el ID en el formulario
        function selectOrder(id, name) {
            document.getElementById('order-id').value = id;
            alert("Has seleccionado la orden de: " + name);
        }

        // Envío del parte al Backend (Ruta PATCH)
        document.getElementById('form-parte').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('order-id').value;
            if (!id) return alert("Selecciona una tarea primero");

            const payload = {
                summary: document.getElementById('summary').value,
                time_spent: parseFloat(document.getElementById('time_spent').value),
                status: document.getElementById('status-final').value
            };

            const res = await fetch(`/work-orders/${id}/complete`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                alert("Parte de trabajo guardado y enviado a Paco.");
                loadWorkOrders();
                e.target.reset();
            }
        });

        // Busca esta función y asegúrate de que cargue loadWorkOrders()
        function showSection(section) {
            document.getElementById('sec-hosteleria').classList.add('hidden');
            document.getElementById('sec-sat').classList.add('hidden');
            document.getElementById('sec-' + section).classList.remove('hidden');

            if (section === 'sat') {
                loadWorkOrders(); 
            } else {
                loadData();
            }
        }

    </script>
</body>

</html>