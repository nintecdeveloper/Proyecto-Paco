<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>PACO ERP | Gestión Total v3.0 - Stock Integrado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

        body { font-family: 'Inter', sans-serif; background: #0f172a; color: #f8fafc; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .modal-bg { backdrop-filter: blur(8px); background: rgba(15, 23, 42, 0.95); }
        .nav-btn { transition: all 0.2s; }
        .nav-active { background: #2563eb; color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        
        /* Switch */
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked+.slider { background-color: #10b981; }
        input:checked+.slider:before { transform: translateX(18px); }
    </style>
</head>

<body class="flex h-screen overflow-hidden text-sm">

    <aside class="w-64 bg-[#1e293b] flex flex-col border-r border-slate-700 shadow-xl z-20">
        <div class="p-6">
            <h1 class="text-2xl font-black text-blue-500 italic tracking-tighter uppercase"><i class="fas fa-cube mr-2"></i>PACO ERP</h1>
        </div>
        <nav class="flex-1 px-4 space-y-2">
            <button onclick="showSection('almacen')" class="nav-btn w-full flex items-center p-3 rounded-lg font-bold text-slate-400 hover:bg-slate-700 hover:text-white nav-active">
                <i class="fas fa-boxes w-8"></i> Almacén
            </button>
            <button onclick="showSection('carta')" class="nav-btn w-full flex items-center p-3 rounded-lg font-bold text-slate-400 hover:bg-slate-700 hover:text-white">
                <i class="fas fa-utensils w-8"></i> Recetas / Carta
            </button>
            <button onclick="showSection('mesas')" class="nav-btn w-full flex items-center p-3 rounded-lg font-bold text-slate-400 hover:bg-slate-700 hover:text-white">
                <i class="fas fa-chair w-8"></i> Sala y Mesas
            </button>
        </nav>
        <div class="p-4 text-xs text-slate-500 text-center font-mono">Sistema Local v3.0</div>
    </aside>

    <main class="flex-1 overflow-y-auto bg-[#0f172a] p-8 relative">
        
        <section id="sec-almacen">
            <div class="flex justify-between items-end mb-8 border-b border-slate-700 pb-4">
                <div>
                    <h2 class="text-3xl font-black text-white uppercase tracking-tight">Inventario</h2>
                    <p class="text-slate-400 text-xs mt-1">Gestión de stock con subunidades automáticas.</p>
                </div>
                <button onclick="openIngModal()" class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-2.5 rounded-lg font-bold shadow-lg transition flex items-center gap-2">
                    <i class="fas fa-plus"></i> Nuevo Producto
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-[#1e293b] rounded-2xl border border-slate-700 overflow-hidden shadow-lg">
                    <div class="p-4 bg-slate-800/50 border-b border-slate-700 flex justify-between items-center">
                        <h3 class="font-black text-orange-400 uppercase tracking-widest text-xs"><i class="fas fa-carrot mr-2"></i>Cocina e Ingredientes</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-800 text-xs uppercase text-slate-400 font-bold">
                                <tr>
                                    <th class="p-4">Producto</th>
                                    <th class="p-4">Stock</th>
                                    <th class="p-4 text-right">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="list-cocina" class="divide-y divide-slate-700 text-sm"></tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-[#1e293b] rounded-2xl border border-slate-700 overflow-hidden shadow-lg">
                    <div class="p-4 bg-slate-800/50 border-b border-slate-700 flex justify-between items-center">
                        <h3 class="font-black text-blue-400 uppercase tracking-widest text-xs"><i class="fas fa-wine-bottle mr-2"></i>Barra y Bebidas</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-800 text-xs uppercase text-slate-400 font-bold">
                                <tr>
                                    <th class="p-4">Producto</th>
                                    <th class="p-4">Stock</th>
                                    <th class="p-4 text-right">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="list-bebidas" class="divide-y divide-slate-700 text-sm"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="sec-carta" class="hidden">
            <div class="flex justify-between items-end mb-8 border-b border-slate-700 pb-4">
                <div>
                    <h2 class="text-3xl font-black text-white uppercase tracking-tight">Menú y Recetas</h2>
                    <p class="text-slate-400 text-xs mt-1">Edita platos y asigna ingredientes.</p>
                </div>
                <button onclick="openPlateModal()" class="bg-orange-500 hover:bg-orange-400 text-white px-5 py-2.5 rounded-lg font-bold shadow-lg transition flex items-center gap-2">
                    <i class="fas fa-plus"></i> Crear Plato
                </button>
            </div>
            <div id="grid-platos" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        </section>

        <section id="sec-mesas" class="hidden">
            <div class="flex justify-between items-end mb-8 border-b border-slate-700 pb-4">
                <div>
                    <h2 class="text-3xl font-black text-white uppercase tracking-tight">Sala</h2>
                    <p class="text-slate-400 text-xs mt-1">Control de sala y comandas.</p>
                </div>
                <button onclick="toggleModal('modal-mesa-create', true)" class="bg-emerald-600 hover:bg-emerald-500 text-white px-5 py-2.5 rounded-lg font-bold shadow-lg transition">
                    <i class="fas fa-plus mr-2"></i> Añadir Mesa
                </button>
            </div>
            <div id="grid-mesas" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6"></div>
        </section>
    </main>

    <div id="modal-ing" class="modal-bg fixed inset-0 hidden items-center justify-center p-4 z-50">
        <div class="bg-[#1e293b] p-8 rounded-2xl w-full max-w-md border border-slate-600 shadow-2xl relative">
            <button onclick="toggleModal('modal-ing', false)" class="absolute top-4 right-4 text-slate-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            <h3 id="modal-ing-title" class="text-xl font-black mb-6 uppercase italic text-blue-400">Nuevo Producto</h3>
            
            <div class="space-y-4">
                <input type="hidden" id="ing-id"> 
                <div>
                    <label class="block text-xs uppercase font-bold text-slate-500 mb-1">Tipo</label>
                    <select id="ing-type" onchange="toggleFormLogic()" class="w-full bg-slate-900 p-3 rounded-lg font-bold border border-slate-700 outline-none text-white">
                        <option value="Cocina">Cocina</option>
                        <option value="Bebida">Bebida</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs uppercase font-bold text-slate-500 mb-1">Nombre</label>
                    <input id="ing-name" class="w-full bg-slate-900 p-3 rounded-lg font-bold border border-slate-700 outline-none text-white">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs uppercase font-bold text-slate-500 mb-1">Stock Actual</label>
                        <input id="ing-stock" type="number" step="0.01" class="w-full bg-slate-900 p-3 rounded-lg font-bold border border-slate-700 outline-none text-white">
                    </div>
                    <div>
                        <label class="block text-xs uppercase font-bold text-slate-500 mb-1">Formato</label>
                        <select id="ing-unit" class="w-full bg-slate-900 p-3 rounded-lg font-bold border border-slate-700 text-blue-400 outline-none">
                            <option value="Unidades">Unidades</option>
                            <option value="Kg">Kilos (Kg)</option>
                            <option value="Litros">Litros (L)</option>
                            <option value="Paquetes">Paquetes</option>
                            <option value="Cajas">Cajas</option>
                        </select>
                    </div>
                </div>

                <div id="box-subunits" class="p-4 bg-slate-800/80 rounded-xl border border-slate-600 mt-2">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-xs font-black uppercase text-orange-400 italic">Conversión Receta</span>
                        <label class="switch">
                            <input type="checkbox" id="toggle-subunits" onchange="toggleSubFields()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div id="sub-fields" class="hidden grid grid-cols-2 gap-3 pt-2 border-t border-slate-600">
                        <div>
                            <label class="text-[9px] uppercase font-bold text-slate-500">1 Unidad contiene...</label>
                            <input id="ing-sub-qty" type="number" placeholder="Ej: 1000" class="w-full bg-slate-900 p-2 rounded text-sm font-bold border border-slate-700 text-white">
                        </div>
                        <div>
                            <label class="text-[9px] uppercase font-bold text-slate-500">Unidad de uso</label>
                            <input id="ing-sub-name" placeholder="Ej: gramos" class="w-full bg-slate-900 p-2 rounded text-sm font-bold border border-slate-700 text-white">
                        </div>
                    </div>
                </div>
                <button onclick="saveIngredient()" class="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-lg font-black uppercase transition mt-4 text-white">Guardar</button>
            </div>
        </div>
    </div>

    <div id="modal-plato" class="modal-bg fixed inset-0 hidden items-center justify-center p-4 z-50">
        <div class="bg-[#1e293b] p-6 md:p-8 rounded-2xl w-full max-w-2xl border border-slate-600 shadow-2xl relative flex flex-col max-h-[90vh]">
            <button onclick="toggleModal('modal-plato', false)" class="absolute top-4 right-4 text-slate-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            <h3 id="modal-plate-title" class="text-2xl font-black mb-6 uppercase text-orange-500 italic">Diseñar Receta</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                <div class="space-y-4">
                    <input type="hidden" id="p-id">
                    <div>
                        <label class="text-xs uppercase font-bold text-slate-500">Nombre del Plato</label>
                        <input id="p-name" class="w-full bg-slate-900 p-3 rounded-lg font-bold border border-slate-700 outline-none text-white">
                    </div>
                    <div>
                        <label class="text-xs uppercase font-bold text-slate-500">Precio (€)</label>
                        <input id="p-price" type="number" step="0.5" class="w-full bg-slate-900 p-3 rounded-lg font-bold border border-slate-700 outline-none text-emerald-400">
                    </div>
                </div>
                <div class="bg-slate-900 p-4 rounded-xl border border-slate-700 flex flex-col">
                    <label class="text-xs uppercase font-bold text-slate-400 mb-2">Añadir Ingrediente</label>
                    <div class="flex gap-2 mb-2">
                        <select id="p-ing-sel" onchange="updateRecipeUI()" class="flex-1 bg-slate-800 p-2 rounded-lg text-sm font-bold border border-slate-600 outline-none text-white"></select>
                    </div>
                    <div class="flex gap-2 items-end mb-2">
                        <div class="flex-1">
                            <label id="p-unit-label" class="text-[10px] uppercase font-bold text-blue-400 block mb-1">Cantidad</label>
                            <input id="p-ing-cant" type="number" class="w-full bg-slate-800 p-2 rounded-lg text-sm font-bold border border-slate-600 text-center text-white">
                        </div>
                        <button onclick="addRecipeItem()" class="bg-blue-600 text-white h-[38px] px-4 rounded-lg font-bold"><i class="fas fa-arrow-down"></i></button>
                    </div>
                </div>
            </div>
            <div class="flex-1 overflow-hidden flex flex-col">
                <div class="bg-slate-900 rounded-xl border border-slate-700 flex-1 overflow-y-auto p-2">
                    <ul id="p-recipe-list" class="space-y-2"></ul>
                    <div id="recipe-empty" class="text-center text-slate-600 text-xs py-8 italic">Añade ingredientes...</div>
                </div>
            </div>
            <button onclick="savePlate()" class="w-full bg-orange-600 hover:bg-orange-500 py-3 rounded-lg font-black uppercase text-white mt-6">Guardar Plato</button>
        </div>
    </div>

    <div id="modal-mesa-create" class="modal-bg fixed inset-0 hidden items-center justify-center p-4 z-50">
        <div class="bg-[#1e293b] p-8 rounded-2xl w-full max-w-sm border border-slate-600">
            <h3 class="text-xl font-black mb-4 uppercase text-white">Nueva Mesa</h3>
            <input id="m-num" type="number" placeholder="Nº Mesa" class="w-full bg-slate-900 p-3 mb-3 rounded-lg border border-slate-700 text-white">
            <button onclick="saveTable()" class="w-full bg-emerald-600 py-3 rounded-lg font-bold text-white uppercase">Crear</button>
            <button onclick="toggleModal('modal-mesa-create', false)" class="w-full mt-2 text-slate-400 text-xs uppercase font-bold">Cancelar</button>
        </div>
    </div>

    <div id="modal-comanda" class="modal-bg fixed inset-0 hidden items-center justify-center p-4 z-50">
        <div class="bg-white text-slate-900 p-6 rounded-3xl w-full max-w-4xl shadow-2xl h-[85vh] flex flex-col relative overflow-hidden">
            <div class="flex justify-between items-center mb-4 border-b pb-4">
                <div>
                    <h2 class="text-3xl font-black italic uppercase text-slate-800">Mesa <span id="comanda-mesa-num" class="text-blue-600"></span></h2>
                    <span id="comanda-status" class="text-xs font-bold uppercase px-2 py-1 bg-gray-200 rounded text-gray-600">Libre</span>
                </div>
                <button onclick="toggleModal('modal-comanda', false)" class="bg-slate-100 hover:bg-slate-200 p-3 rounded-full transition"><i class="fas fa-times text-xl"></i></button>
            </div>

            <div class="flex-1 flex gap-6 min-h-0">
                <div class="w-1/3 flex flex-col gap-3">
                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200 flex-1 flex flex-col">
                        <label class="text-xs font-bold uppercase text-slate-400 mb-2">Añadir a la cuenta</label>
                        <select id="comanda-select" class="w-full bg-white p-3 rounded-xl border border-slate-300 font-bold mb-3 outline-none focus:border-blue-500"></select>
                        <button onclick="addToOrder()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl font-black uppercase transition shadow-lg">
                            <i class="fas fa-plus mr-2"></i> Añadir
                        </button>
                    </div>
                    
                    <button onclick="deleteTable()" class="mt-auto bg-red-100 hover:bg-red-200 text-red-600 py-3 rounded-xl font-bold text-xs uppercase transition">
                        <i class="fas fa-trash mr-2"></i> Eliminar Mesa
                    </button>
                </div>

                <div class="w-2/3 flex flex-col bg-slate-50 rounded-2xl border border-slate-200 overflow-hidden">
                    <div class="bg-slate-100 p-3 border-b border-slate-200 flex justify-between font-bold text-xs uppercase text-slate-500">
                        <span>Concepto</span>
                        <span>Precio</span>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4">
                        <ul id="comanda-list" class="space-y-3"></ul>
                        <div id="comanda-empty" class="text-center text-slate-400 italic mt-10">La comanda está vacía.</div>
                    </div>
                    <div class="bg-white p-6 border-t border-slate-200">
                        <div class="flex justify-between items-end mb-4">
                            <span class="text-sm font-bold text-slate-400 uppercase">Total a Pagar</span>
                            <span id="comanda-total" class="text-4xl font-black text-slate-800">0.00€</span>
                        </div>
                        <button onclick="closeTable()" class="w-full bg-emerald-500 hover:bg-emerald-400 text-white py-4 rounded-xl font-black text-lg uppercase shadow-xl transition transform active:scale-95">
                            <i class="fas fa-check-circle mr-2"></i> Cobrar y Liberar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // BASE DE DATOS LOCAL
        const DB = {
            init: () => {
                if(!localStorage.getItem('paco_ings')) localStorage.setItem('paco_ings', JSON.stringify([]));
                if(!localStorage.getItem('paco_plates')) localStorage.setItem('paco_plates', JSON.stringify([]));
                if(!localStorage.getItem('paco_tables')) localStorage.setItem('paco_tables', JSON.stringify([]));
            },
            get: (key) => JSON.parse(localStorage.getItem(key)),
            set: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
            addOrUpdate: (key, item) => {
                let list = DB.get(key);
                const index = list.findIndex(i => i.id == item.id);
                if (index >= 0) list[index] = item; else list.push(item);
                DB.set(key, list);
            },
            delete: (key, id) => {
                let list = DB.get(key);
                list = list.filter(i => i.id != id);
                DB.set(key, list);
            }
        };

        DB.init();

        // VARIABLES GLOBALES
        let curRecipe = []; 
        let allIngredients = [];
        let activeTableId = null;

        // --- NAVEGACIÓN ---
        function showSection(id) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('nav-active', 'bg-blue-600', 'text-white');
                b.classList.add('text-slate-400');
            });
            document.getElementById('sec-' + id).classList.remove('hidden');
            const btn = event ? event.currentTarget : document.querySelector(`button[onclick="showSection('${id}')"]`);
            if(btn) { btn.classList.add('nav-active'); btn.classList.remove('text-slate-400'); }

            if (id === 'almacen') loadStock();
            if (id === 'carta') loadPlates();
            if (id === 'mesas') loadTables();
        }

        function toggleModal(id, show) {
            const el = document.getElementById(id);
            show ? (el.classList.remove('hidden'), el.classList.add('flex')) : (el.classList.add('hidden'), el.classList.remove('flex'));
        }

        // --- ALMACÉN ---
        function openIngModal(editData = null) {
            if(editData && typeof editData === 'string') editData = JSON.parse(decodeURIComponent(editData));
            const title = document.getElementById('modal-ing-title');
            if (editData) {
                title.innerText = "Editar Producto";
                document.getElementById('ing-id').value = editData.id;
                document.getElementById('ing-type').value = editData.type;
                document.getElementById('ing-name').value = editData.name;
                document.getElementById('ing-stock').value = editData.stock;
                document.getElementById('ing-unit').value = editData.unit;
                const hasSub = (editData.sub_qty && editData.sub_qty > 1) || (editData.unit === 'Kg' || editData.unit === 'Litros');
                document.getElementById('toggle-subunits').checked = hasSub;
                if(hasSub) {
                    document.getElementById('ing-sub-qty').value = editData.sub_qty;
                    document.getElementById('ing-sub-name').value = editData.sub_name;
                }
            } else {
                title.innerText = "Nuevo Producto";
                document.getElementById('ing-id').value = "";
                document.getElementById('ing-name').value = "";
                document.getElementById('ing-stock').value = "";
                document.getElementById('toggle-subunits').checked = false;
                document.getElementById('ing-sub-qty').value = "";
                document.getElementById('ing-sub-name').value = "";
            }
            toggleFormLogic();
            toggleModal('modal-ing', true);
        }

        function toggleFormLogic() {
            const type = document.getElementById('ing-type').value;
            const subBox = document.getElementById('box-subunits');
            type === 'Bebida' ? subBox.classList.add('hidden') : subBox.classList.remove('hidden');
            toggleSubFields();
        }

        function toggleSubFields() {
            const checked = document.getElementById('toggle-subunits').checked;
            const fields = document.getElementById('sub-fields');
            checked ? fields.classList.remove('hidden') : fields.classList.add('hidden');
        }

        function saveIngredient() {
            const id = document.getElementById('ing-id').value;
            const unit = document.getElementById('ing-unit').value;
            const hasSub = document.getElementById('toggle-subunits').checked;
            let subQty = 1; let subName = unit;
            if (unit === "Kg") { subQty = 1000; subName = "gramos"; }
            else if (unit === "Litros") { subQty = 1000; subName = "ml"; }
            else if (hasSub) {
                subQty = parseFloat(document.getElementById('ing-sub-qty').value) || 1;
                subName = document.getElementById('ing-sub-name').value;
            }
            const payload = {
                id: id ? parseInt(id) : Date.now(),
                type: document.getElementById('ing-type').value,
                name: document.getElementById('ing-name').value,
                stock: parseFloat(document.getElementById('ing-stock').value) || 0,
                unit: unit,
                sub_qty: subQty,
                sub_name: subName
            };
            DB.addOrUpdate('paco_ings', payload);
            toggleModal('modal-ing', false);
            loadStock();
        }

        function deleteIngredient(id) {
            if(!confirm("¿Eliminar este producto?")) return;
            DB.delete('paco_ings', id);
            loadStock();
        }

        function loadStock() {
            allIngredients = DB.get('paco_ings');
            const renderTable = (listId, type) => {
                const filtered = allIngredients.filter(i => i.type === type);
                document.getElementById(listId).innerHTML = filtered.map(i => {
                    const safeObj = encodeURIComponent(JSON.stringify(i));
                    return `
                    <tr class="hover:bg-slate-700/50 transition border-b border-slate-700/50 last:border-0">
                        <td class="p-4">
                            <div class="font-bold text-slate-200">${i.name}</div>
                            <div class="text-[10px] text-slate-500 italic">${i.sub_qty > 1 ? `1 ${i.unit} = ${i.sub_qty} ${i.sub_name}` : 'Unidad simple'}</div>
                        </td>
                        <td class="p-4 font-mono text-emerald-400 font-bold">${i.stock.toFixed(2)} <span class="text-xs text-slate-500">${i.unit}</span></td>
                        <td class="p-4 text-right space-x-2">
                            <button onclick='openIngModal("${safeObj}")' class="text-blue-400 hover:text-blue-300 p-2"><i class="fas fa-pen"></i></button>
                            <button onclick="deleteIngredient(${i.id})" class="text-red-400 hover:text-red-300 p-2"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`
                }).join('');
            };
            renderTable('list-cocina', 'Cocina');
            renderTable('list-bebidas', 'Bebida');
        }

        // --- PLATOS ---
        function openPlateModal(plateData = null) {
            if(plateData && typeof plateData === 'string') plateData = JSON.parse(decodeURIComponent(plateData));
            loadIngredientsForRecipe();
            if(plateData) {
                document.getElementById('modal-plate-title').innerText = "Editar Receta";
                document.getElementById('p-id').value = plateData.id;
                document.getElementById('p-name').value = plateData.name;
                document.getElementById('p-price').value = plateData.price;
                curRecipe = plateData.recipe || [];
            } else {
                document.getElementById('modal-plate-title').innerText = "Nueva Receta";
                document.getElementById('p-id').value = "";
                document.getElementById('p-name').value = "";
                document.getElementById('p-price').value = "";
                curRecipe = [];
            }
            renderRecipeList();
            toggleModal('modal-plato', true);
        }

        function loadIngredientsForRecipe() {
            const ings = DB.get('paco_ings').filter(i => i.type === 'Cocina');
            document.getElementById('p-ing-sel').innerHTML = `<option value="">Selecciona ingrediente...</option>` + 
                ings.map(i => `<option value='${JSON.stringify(i)}'>${i.name}</option>`).join('');
        }

        function updateRecipeUI() {
            const sel = document.getElementById('p-ing-sel');
            if (!sel.value) return;
            const ing = JSON.parse(sel.value);
            const label = document.getElementById('p-unit-label');
            const displayUnit = ing.sub_name || ing.unit;
            label.innerText = `Cantidad en ${displayUnit}`;
            label.classList.add('text-orange-400');
            document.getElementById('p-ing-cant').focus();
        }

        function addRecipeItem() {
            const sel = document.getElementById('p-ing-sel');
            if(!sel.value) return alert("Selecciona un ingrediente");
            const ing = JSON.parse(sel.value);
            const cantInput = parseFloat(document.getElementById('p-ing-cant').value);
            if (!cantInput || cantInput <= 0) return alert("Cantidad inválida");

            curRecipe.push({
                id: ing.id,
                name: ing.name,
                stock_cost: cantInput / (ing.sub_qty || 1),
                display_qty: cantInput,
                display_unit: ing.sub_name || ing.unit
            });
            renderRecipeList();
            document.getElementById('p-ing-cant').value = "";
            sel.value = "";
        }

        function removeRecipeItem(index) {
            curRecipe.splice(index, 1);
            renderRecipeList();
        }

        function renderRecipeList() {
            const list = document.getElementById('p-recipe-list');
            if(curRecipe.length === 0) { list.innerHTML = ""; document.getElementById('recipe-empty').classList.remove('hidden'); return; }
            document.getElementById('recipe-empty').classList.add('hidden');
            list.innerHTML = curRecipe.map((item, idx) => `
                <li class="flex justify-between items-center bg-slate-800 p-3 rounded-lg border border-slate-700">
                    <div><span class="font-bold text-white block">${item.name}</span><span class="text-xs text-blue-400 font-mono">${item.display_qty} ${item.display_unit}</span></div>
                    <button onclick="removeRecipeItem(${idx})" class="text-red-500 hover:bg-slate-700 p-2"><i class="fas fa-times"></i></button>
                </li>`).join('');
        }

        function savePlate() {
            const payload = {
                id: document.getElementById('p-id').value ? parseInt(document.getElementById('p-id').value) : Date.now(),
                name: document.getElementById('p-name').value,
                price: parseFloat(document.getElementById('p-price').value),
                recipe: curRecipe
            };
            if(!payload.name || !payload.price) return alert("Faltan datos");
            DB.addOrUpdate('paco_plates', payload);
            toggleModal('modal-plato', false);
            loadPlates();
        }

        function deletePlate(id) {
            if(!confirm("¿Borrar este plato?")) return;
            DB.delete('paco_plates', id);
            loadPlates();
        }

        function loadPlates() {
            const plates = DB.get('paco_plates');
            document.getElementById('grid-platos').innerHTML = plates.map(p => {
                const safeObj = encodeURIComponent(JSON.stringify(p));
                return `
                <div class="bg-[#1e293b] p-6 rounded-2xl border border-slate-700 shadow-lg group hover:border-orange-500/50 transition relative">
                    <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition flex gap-2">
                        <button onclick='openPlateModal("${safeObj}")' class="bg-blue-600 text-white p-2 rounded-lg text-xs"><i class="fas fa-pen"></i></button>
                        <button onclick="deletePlate(${p.id})" class="bg-red-600 text-white p-2 rounded-lg text-xs"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="h-10 w-10 bg-orange-500/20 rounded-full flex items-center justify-center mb-4 text-orange-500"><i class="fas fa-utensils"></i></div>
                    <h4 class="font-black uppercase italic text-lg text-white mb-1 leading-tight">${p.name}</h4>
                    <div class="text-2xl font-black text-emerald-400">${p.price.toFixed(2)}€</div>
                </div>`
            }).join('');
        }

        // --- MESAS Y GESTIÓN DE STOCK ---
        function saveTable() {
            const payload = { id: Date.now(), number: document.getElementById('m-num').value, status: 'Libre', order: [] };
            DB.addOrUpdate('paco_tables', payload);
            toggleModal('modal-mesa-create', false); 
            loadTables();
        }

        function loadTables() {
            const tables = DB.get('paco_tables');
            document.getElementById('grid-mesas').innerHTML = tables.map(t => `
                <div onclick="openComanda(${t.id})" class="h-32 rounded-3xl cursor-pointer flex flex-col items-center justify-center transition border-b-4 shadow-xl hover:translate-y-1 relative overflow-hidden
                    ${t.status === 'Libre' ? 'bg-emerald-600 border-emerald-800 text-white' : 'bg-red-500 border-red-800 text-white'}">
                    <span class="text-4xl font-black italic uppercase z-10">${t.number}</span>
                    <span class="text-[10px] font-black uppercase opacity-80 italic z-10 mt-2">${t.status}</span>
                    ${t.order && t.order.length > 0 ? '<i class="fas fa-utensils absolute text-6xl opacity-20 -bottom-2 -right-2"></i>' : ''}
                </div>`).join('');
        }

        function openComanda(id) {
            activeTableId = id;
            const tables = DB.get('paco_tables');
            const table = tables.find(t => t.id === id);
            if (!table) return;

            document.getElementById('comanda-mesa-num').innerText = table.number;
            const statTag = document.getElementById('comanda-status');
            statTag.innerText = table.status;
            statTag.className = `text-xs font-bold uppercase px-2 py-1 rounded ${table.status === 'Libre' ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-red-600'}`;

            const plates = DB.get('paco_plates');
            const drinks = DB.get('paco_ings').filter(i => i.type === 'Bebida');
            const sel = document.getElementById('comanda-select');
            
            let html = `<option value="">Selecciona...</option>`;
            html += `<optgroup label="PLATOS">` + plates.map(p => `<option value='{"type":"plate","id":${p.id},"name":"${p.name}","price":${p.price}}'>${p.name} - ${p.price}€</option>`).join('') + `</optgroup>`;
            html += `<optgroup label="BEBIDAS">` + drinks.map(d => `<option value='{"type":"drink","id":${d.id},"name":"${d.name}","price":2.50}'>${d.name} - 2.50€</option>`).join('') + `</optgroup>`;
            sel.innerHTML = html;

            renderOrderList(table);
            toggleModal('modal-comanda', true);
        }

        function addToOrder() {
            const sel = document.getElementById('comanda-select');
            if(!sel.value) return;
            const item = JSON.parse(sel.value);
            const tables = DB.get('paco_tables');
            const table = tables.find(t => t.id === activeTableId);
            if(!table.order) table.order = [];
            table.order.push(item);
            table.status = 'Ocupada';
            DB.addOrUpdate('paco_tables', table);
            openComanda(activeTableId);
            loadTables();
        }

        function renderOrderList(table) {
            const list = document.getElementById('comanda-list');
            const empty = document.getElementById('comanda-empty');
            const totalEl = document.getElementById('comanda-total');

            if(!table.order || table.order.length === 0) {
                list.innerHTML = "";
                empty.classList.remove('hidden');
                totalEl.innerText = "0.00€";
                return;
            }

            empty.classList.add('hidden');
            let total = 0;
            list.innerHTML = table.order.map((item, idx) => {
                total += item.price;
                return `
                <li class="flex justify-between items-center bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                    <span class="font-bold text-slate-700">${item.name}</span>
                    <div class="flex items-center gap-3">
                        <span class="font-mono text-slate-500">${item.price.toFixed(2)}€</span>
                        <button onclick="removeFromOrder(${idx})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </li>`;
            }).join('');
            totalEl.innerText = total.toFixed(2) + "€";
        }

        function removeFromOrder(idx) {
            const tables = DB.get('paco_tables');
            const table = tables.find(t => t.id === activeTableId);
            table.order.splice(idx, 1);
            if(table.order.length === 0) table.status = 'Libre';
            DB.addOrUpdate('paco_tables', table);
            openComanda(activeTableId);
            loadTables();
        }

        // --- LÓGICA DE ACTUALIZACIÓN DE STOCK AL COBRAR ---
        function closeTable() {
            if(!confirm("¿Cobrar mesa y descontar ingredientes del stock?")) return;
            
            const tables = DB.get('paco_tables');
            const table = tables.find(t => t.id === activeTableId);
            const plates = DB.get('paco_plates');
            const ingredients = DB.get('paco_ings');

            // Recorrer cada item de la comanda cobrada
            table.order.forEach(item => {
                if (item.type === 'plate') {
                    // Si es un plato, buscamos su receta original en la base de datos de platos
                    const originalPlate = plates.find(p => p.id === item.id);
                    if (originalPlate && originalPlate.recipe) {
                        originalPlate.recipe.forEach(recItem => {
                            const ingIdx = ingredients.findIndex(i => i.id === recItem.id);
                            if (ingIdx >= 0) {
                                // Descontamos el coste de stock (calculado en addRecipeItem)
                                ingredients[ingIdx].stock -= recItem.stock_cost;
                            }
                        });
                    }
                } else if (item.type === 'drink') {
                    // Si es bebida, descontamos 1 unidad del stock directamente
                    const ingIdx = ingredients.findIndex(i => i.id === item.id);
                    if (ingIdx >= 0) {
                        ingredients[ingIdx].stock -= 1;
                    }
                }
            });

            // Guardar stock actualizado
            DB.set('paco_ings', ingredients);

            // Limpiar mesa
            table.order = [];
            table.status = 'Libre';
            DB.addOrUpdate('paco_tables', table);

            toggleModal('modal-comanda', false);
            loadTables();
            loadStock(); // Refrescar vista de almacén por si acaso
            alert("Mesa cerrada. Stock actualizado con éxito.");
        }

        function deleteTable() {
            if(!confirm("¿Eliminar esta mesa definitivamente?")) return;
            DB.delete('paco_tables', activeTableId);
            toggleModal('modal-comanda', false);
            loadTables();
        }

        window.onload = () => showSection('almacen');
    </script>
</body>
</html>