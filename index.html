<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>PACO ERP | Gesti√≥n Total v4.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

        body { font-family: 'Inter', sans-serif; background: #0f172a; color: #f8fafc; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .modal-bg { backdrop-filter: blur(8px); background: rgba(15, 23, 42, 0.95); }
        .nav-btn { transition: all 0.2s; }
        .nav-active { background: #2563eb; color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        /* Switch */
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked+.slider { background-color: #10b981; }
        input:checked+.slider:before { transform: translateX(18px); }
        /* Ticket Pattern */
        .ticket-jagged {
            background: radial-gradient(circle, transparent, transparent 50%, #f8fafc 50%, #f8fafc 100%) -10px -10px / 20px 20px repeat-x;
        }
    </style>
</head>

<body class="flex h-screen overflow-hidden text-sm">

    <aside class="w-64 bg-[#1e293b] flex flex-col border-r border-slate-700 shadow-xl z-20">
        <div class="p-6">
            <h1 class="text-2xl font-black text-blue-500 italic tracking-tighter uppercase"><i class="fas fa-cube mr-2"></i>PACO ERP</h1>
        </div>
        <nav class="flex-1 px-4 space-y-2">
            <button onclick="showSection('almacen')" class="nav-btn w-full flex items-center p-3 rounded-lg font-bold text-slate-400 hover:bg-slate-700 hover:text-white nav-active">
                <i class="fas fa-boxes w-8"></i> Almac√©n
            </button>
            <button onclick="showSection('carta')" class="nav-btn w-full flex items-center p-3 rounded-lg font-bold text-slate-400 hover:bg-slate-700 hover:text-white">
                <i class="fas fa-utensils w-8"></i> Recetas / Carta
            </button>
            <button onclick="showSection('mesas')" class="nav-btn w-full flex items-center p-3 rounded-lg font-bold text-slate-400 hover:bg-slate-700 hover:text-white">
                <i class="fas fa-chair w-8"></i> Sala y Mesas
            </button>
        </nav>
        <button onclick="showSection('historial')" class="nav-btn w-full flex items-center p-3 rounded-lg font-bold text-slate-400 hover:bg-slate-700 hover:text-white">
            <i class="fas fa-history w-8"></i> Historial
        </button>
        <div class="p-4 text-xs text-slate-500 text-center font-mono">Versi√≥n 4.2</div>
    </aside>

    <main class="flex-1 overflow-y-auto bg-[#0f172a] p-8 relative">

        <section id="sec-almacen">
            <div class="flex justify-between items-end mb-8 border-b border-slate-700 pb-4">
                <div>
                    <h2 class="text-3xl font-black text-white uppercase tracking-tight">Inventario</h2>
                    <p class="text-slate-400 text-xs mt-1">Gesti√≥n de stock en tiempo real.</p>
                </div>
                <div class="flex gap-3">
                    <select id="stock-sort" onchange="loadStock()" class="bg-slate-800 text-slate-300 text-xs font-bold p-2.5 rounded-lg border border-slate-600 outline-none">
                        <option value="name">üî§ Nombre (A-Z)</option>
                        <option value="stock-asc">üìâ Stock (Menor a Mayor)</option>
                        <option value="stock-desc">üìà Stock (Mayor a Menor)</option>
                    </select>
                    <button onclick="openIngModal()" class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-2.5 rounded-lg font-bold shadow-lg transition flex items-center gap-2">
                        <i class="fas fa-plus"></i> Nuevo Producto
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-[#1e293b] rounded-2xl border border-slate-700 overflow-hidden shadow-lg">
                    <div class="p-4 bg-slate-800/50 border-b border-slate-700 flex justify-between items-center">
                        <h3 class="font-black text-orange-400 uppercase tracking-widest text-xs"><i class="fas fa-carrot mr-2"></i>Cocina</h3>
                    </div>
                    <div class="overflow-x-auto max-h-[60vh] overflow-y-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-800 text-xs uppercase text-slate-400 font-bold sticky top-0 z-10">
                                <tr>
                                    <th class="p-4">Producto</th>
                                    <th class="p-4">Stock</th>
                                    <th class="p-4 text-right">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="list-cocina" class="divide-y divide-slate-700 text-sm"></tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-[#1e293b] rounded-2xl border border-slate-700 overflow-hidden shadow-lg">
                    <div class="p-4 bg-slate-800/50 border-b border-slate-700 flex justify-between items-center">
                        <h3 class="font-black text-blue-400 uppercase tracking-widest text-xs"><i class="fas fa-wine-bottle mr-2"></i>Bebidas</h3>
                    </div>
                    <div class="overflow-x-auto max-h-[60vh] overflow-y-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-800 text-xs uppercase text-slate-400 font-bold sticky top-0 z-10">
                                <tr>
                                    <th class="p-4">Producto</th>
                                    <th class="p-4">Stock</th>
                                    <th class="p-4 text-right">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="list-bebidas" class="divide-y divide-slate-700 text-sm"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="sec-carta" class="hidden">
            <div class="flex justify-between items-end mb-8 border-b border-slate-700 pb-4">
                <div>
                    <h2 class="text-3xl font-black text-white uppercase tracking-tight">Men√∫ y Recetas</h2>
                    <p class="text-slate-400 text-xs mt-1">Edita platos y asigna ingredientes.</p>
                </div>
                <button onclick="openPlateModal()" class="bg-orange-500 hover:bg-orange-400 text-white px-5 py-2.5 rounded-lg font-bold shadow-lg transition flex items-center gap-2">
                    <i class="fas fa-plus"></i> Crear Plato
                </button>
            </div>
            <div id="grid-platos" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        </section>

        <section id="sec-mesas" class="hidden">
            <div class="flex justify-between items-end mb-8 border-b border-slate-700 pb-4">
                <div>
                    <h2 class="text-3xl font-black text-white uppercase tracking-tight">Sala</h2>
                    <p class="text-slate-400 text-xs mt-1">Control de sala, capacidades y comandas.</p>
                </div>
                <button onclick="openMesaModal()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-5 py-2.5 rounded-lg font-bold shadow-lg transition">
                    <i class="fas fa-plus mr-2"></i> A√±adir Mesa
                </button>
            </div>
            <div id="grid-mesas" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6"></div>
        </section>

        <section id="sec-historial" class="hidden">
            <div class="flex justify-between items-end mb-8 border-b border-slate-700 pb-4">
                <div>
                    <h2 class="text-3xl font-black text-white uppercase tracking-tight">Caja e Historial</h2>
                    <p class="text-slate-400 text-xs mt-1">Haz clic en una venta para ver el ticket detallado.</p>
                </div>
                <button onclick="clearHistory()" class="bg-red-600/20 hover:bg-red-600 text-red-400 px-4 py-2 rounded-lg font-bold text-xs transition">
                    <i class="fas fa-eraser mr-2"></i> Limpiar Todo
                </button>
            </div>

            <div class="bg-[#1e293b] rounded-2xl border border-slate-700 overflow-hidden shadow-lg">
                <table class="w-full text-left">
                    <thead class="bg-slate-800 text-xs uppercase text-slate-400 font-bold">
                        <tr>
                            <th class="p-4">Fecha Cobro</th>
                            <th class="p-4">Mesa</th>
                            <th class="p-4">Resumen</th>
                            <th class="p-4 text-right">Total</th>
                        </tr>
                    </thead>
                    <tbody id="list-historial" class="divide-y divide-slate-700 text-sm"></tbody>
                </table>
            </div>
        </section>
    </main>

    <div id="modal-ing" class="modal-bg fixed inset-0 hidden items-center justify-center p-4 z-50">
        <div class="bg-[#1e293b] p-8 rounded-2xl w-full max-w-md border border-slate-600 shadow-2xl relative">
            <button onclick="toggleModal('modal-ing', false)" class="absolute top-4 right-4 text-slate-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            <h3 id="modal-ing-title" class="text-xl font-black mb-6 uppercase italic text-blue-400">Nuevo Producto</h3>
            <div class="space-y-4">
                <input type="hidden" id="ing-id">
                <div>
                    <label class="block text-xs uppercase font-bold text-slate-500 mb-1">Tipo</label>
                    <select id="ing-type" onchange="toggleFormLogic()" class="w-full bg-slate-900 p-3 rounded-lg font-bold border border-slate-700 outline-none text-white">
                        <option value="Cocina">Cocina</option>
                        <option value="Bebida">Bebida</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs uppercase font-bold text-slate-500 mb-1">Nombre</label>
                    <input id="ing-name" class="w-full bg-slate-900 p-3 rounded-lg font-bold border border-slate-700 outline-none text-white">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs uppercase font-bold text-slate-500 mb-1">Stock Actual</label>
                        <input id="ing-stock" type="number" step="0.01" class="w-full bg-slate-900 p-3 rounded-lg font-bold border border-slate-700 outline-none text-white">
                    </div>
                    <div>
                        <label class="block text-xs uppercase font-bold text-slate-500 mb-1">Formato</label>
                        <select id="ing-unit" class="w-full bg-slate-900 p-3 rounded-lg font-bold border border-slate-700 text-blue-400 outline-none">
                            <option value="Unidades">Unidades</option>
                            <option value="Kg">Kilos (Kg)</option>
                            <option value="Litros">Litros (L)</option>
                            <option value="Paquetes">Paquetes</option>
                            <option value="Cajas">Cajas</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-xs uppercase font-bold text-red-400 mb-1"><i class="fas fa-bell mr-1"></i> Stock M√≠nimo (Alerta)</label>
                    <input id="ing-min-stock" type="number" step="0.01" class="w-full bg-slate-900 p-3 rounded-lg font-bold border border-slate-700 outline-none text-white focus:border-red-500">
                </div>
                <div id="box-subunits" class="p-4 bg-slate-800/80 rounded-xl border border-slate-600 mt-2">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-xs font-black uppercase text-orange-400 italic">Conversi√≥n Receta</span>
                        <label class="switch">
                            <input type="checkbox" id="toggle-subunits" onchange="toggleSubFields()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div id="sub-fields" class="hidden grid grid-cols-2 gap-3 pt-2 border-t border-slate-600">
                        <div>
                            <label class="text-[9px] uppercase font-bold text-slate-500">1 Unidad contiene...</label>
                            <input id="ing-sub-qty" type="number" placeholder="Ej: 1000" class="w-full bg-slate-900 p-2 rounded text-sm font-bold border border-slate-700 text-white">
                        </div>
                        <div>
                            <label class="text-[9px] uppercase font-bold text-slate-500">Unidad de uso</label>
                            <input id="ing-sub-name" placeholder="Ej: gramos" class="w-full bg-slate-900 p-2 rounded text-sm font-bold border border-slate-700 text-white">
                        </div>
                    </div>
                </div>
                <button onclick="saveIngredient()" class="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-lg font-black uppercase transition mt-4 text-white">Guardar</button>
            </div>
        </div>
    </div>

    <div id="modal-plato" class="modal-bg fixed inset-0 hidden items-center justify-center p-4 z-50">
        <div class="bg-[#1e293b] p-6 md:p-8 rounded-2xl w-full max-w-2xl border border-slate-600 shadow-2xl relative flex flex-col max-h-[90vh]">
            <button onclick="toggleModal('modal-plato', false)" class="absolute top-4 right-4 text-slate-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            <h3 id="modal-plate-title" class="text-2xl font-black mb-6 uppercase text-orange-500 italic">Dise√±ar Receta</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                <div class="space-y-4">
                    <input type="hidden" id="p-id">
                    <div>
                        <label class="text-xs uppercase font-bold text-slate-500">Nombre del Plato</label>
                        <input id="p-name" class="w-full bg-slate-900 p-3 rounded-lg font-bold border border-slate-700 outline-none text-white">
                    </div>
                    <div>
                        <label class="text-xs uppercase font-bold text-slate-500">Precio (‚Ç¨)</label>
                        <input id="p-price" type="number" step="0.5" class="w-full bg-slate-900 p-3 rounded-lg font-bold border border-slate-700 outline-none text-emerald-400">
                    </div>
                </div>
                <div class="bg-slate-900 p-4 rounded-xl border border-slate-700 flex flex-col">
                    <label class="text-xs uppercase font-bold text-slate-400 mb-2">A√±adir Ingrediente</label>
                    <div class="flex gap-2 mb-2">
                        <select id="p-ing-sel" onchange="updateRecipeUI()" class="flex-1 bg-slate-800 p-2 rounded-lg text-sm font-bold border border-slate-600 outline-none text-white"></select>
                    </div>
                    <div class="flex gap-2 items-end mb-2">
                        <div class="flex-1">
                            <label id="p-unit-label" class="text-[10px] uppercase font-bold text-blue-400 block mb-1">Cantidad</label>
                            <input id="p-ing-cant" type="number" class="w-full bg-slate-800 p-2 rounded-lg text-sm font-bold border border-slate-600 text-center text-white">
                        </div>
                        <button onclick="addRecipeItem()" class="bg-blue-600 text-white h-[38px] px-4 rounded-lg font-bold"><i class="fas fa-arrow-down"></i></button>
                    </div>
                </div>
            </div>
            <div class="flex-1 overflow-hidden flex flex-col">
                <div class="bg-slate-900 rounded-xl border border-slate-700 flex-1 overflow-y-auto p-2">
                    <ul id="p-recipe-list" class="space-y-2"></ul>
                    <div id="recipe-empty" class="text-center text-slate-600 text-xs py-8 italic">A√±ade ingredientes...</div>
                </div>
            </div>
            <button onclick="savePlate()" class="w-full bg-orange-600 hover:bg-orange-500 py-3 rounded-lg font-black uppercase text-white mt-6">Guardar Plato</button>
        </div>
    </div>

    <div id="modal-mesa-create" class="modal-bg fixed inset-0 hidden items-center justify-center p-4 z-50">
        <div class="bg-[#1e293b] p-8 rounded-2xl w-full max-w-sm border border-slate-600 shadow-2xl relative">
            <button onclick="toggleModal('modal-mesa-create', false)" class="absolute top-4 right-4 text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
            <h3 id="modal-mesa-title" class="text-xl font-black mb-6 uppercase text-white italic text-emerald-400">Nueva Mesa</h3>
            <div class="space-y-4">
                <input type="hidden" id="m-id-edit">
                <div>
                    <label class="block text-xs uppercase font-bold text-slate-500 mb-1">N√∫mero de Mesa</label>
                    <input id="m-num" type="number" placeholder="Ej: 1" class="w-full bg-slate-900 p-3 rounded-lg border border-slate-700 text-white font-bold outline-none focus:border-emerald-500">
                </div>
                <div>
                    <label class="block text-xs uppercase font-bold text-slate-500 mb-1">Capacidad (Comensales)</label>
                    <input id="m-cap" type="number" placeholder="Ej: 4" class="w-full bg-slate-900 p-3 rounded-lg border border-slate-700 text-white font-bold outline-none focus:border-emerald-500">
                </div>
                <button onclick="saveTable()" class="w-full bg-emerald-600 hover:bg-emerald-500 py-3 rounded-lg font-black text-white uppercase transition shadow-lg">
                    Guardar Mesa
                </button>
            </div>
        </div>
    </div>

    <div id="modal-comanda" class="modal-bg fixed inset-0 hidden items-center justify-center p-4 z-50">
        <div class="bg-white text-slate-900 p-6 rounded-3xl w-full max-w-4xl shadow-2xl h-[85vh] flex flex-col relative overflow-hidden">
            <div class="flex justify-between items-center mb-4 border-b pb-4">
                <div>
                    <h2 class="text-3xl font-black italic uppercase text-slate-800">Mesa <span id="comanda-mesa-num" class="text-blue-600"></span></h2>
                    <span id="comanda-status" class="text-xs font-bold uppercase px-2 py-1 bg-gray-200 rounded text-gray-600">Libre</span>
                </div>
                <button onclick="toggleModal('modal-comanda', false)" class="bg-slate-100 hover:bg-slate-200 p-3 rounded-full transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="flex-1 flex gap-6 min-h-0">
                <div class="w-1/3 flex flex-col gap-3">
                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200 flex-1 flex flex-col">
                        <label class="text-xs font-bold uppercase text-slate-400 mb-2">A√±adir a la cuenta</label>
                        <select id="comanda-select" class="w-full bg-white p-3 rounded-xl border border-slate-300 font-bold mb-3 outline-none focus:border-blue-500"></select>
                        <button onclick="addToOrder()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl font-black uppercase transition shadow-lg">
                            <i class="fas fa-plus mr-2"></i> A√±adir
                        </button>
                    </div>
                    <button onclick="deleteTable()" class="mt-auto bg-red-100 hover:bg-red-200 text-red-600 py-3 rounded-xl font-bold text-xs uppercase transition">
                        <i class="fas fa-trash mr-2"></i> Eliminar Mesa
                    </button>
                </div>
                <div class="w-2/3 flex flex-col bg-slate-50 rounded-2xl border border-slate-200 overflow-hidden">
                    <div class="bg-slate-100 p-3 border-b border-slate-200 flex justify-between font-bold text-xs uppercase text-slate-500">
                        <span>Concepto</span>
                        <span>Precio</span>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4">
                        <ul id="comanda-list" class="space-y-3"></ul>
                        <div id="comanda-empty" class="text-center text-slate-400 italic mt-10">La comanda est√° vac√≠a.</div>
                    </div>
                    <div class="bg-white p-6 border-t border-slate-200">
                        <div class="flex justify-between items-end mb-4">
                            <span class="text-sm font-bold text-slate-400 uppercase">Total a Pagar</span>
                            <span id="comanda-total" class="text-4xl font-black text-slate-800">0.00‚Ç¨</span>
                        </div>
                        <button onclick="closeTable()" class="w-full bg-emerald-500 hover:bg-emerald-400 text-white py-4 rounded-xl font-black text-lg uppercase shadow-xl transition transform active:scale-95">
                            <i class="fas fa-check-circle mr-2"></i> Cobrar y Liberar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-ticket" class="modal-bg fixed inset-0 hidden items-center justify-center p-4 z-50">
        <div class="bg-[#f8fafc] text-slate-900 w-full max-w-sm shadow-2xl relative overflow-hidden flex flex-col items-center">
            <div class="w-full bg-white p-6 pb-10">
                <div class="flex justify-between items-start mb-6">
                    <div class="text-center w-full">
                        <h2 class="text-2xl font-black uppercase tracking-tighter">PACO ERP</h2>
                        <p class="text-[10px] text-slate-400 uppercase tracking-widest">Ticket de Venta</p>
                    </div>
                    <button onclick="toggleModal('modal-ticket', false)" class="absolute top-4 right-4 text-slate-400 hover:text-slate-800"><i class="fas fa-times"></i></button>
                </div>

                <div class="border-b-2 border-dashed border-slate-300 pb-4 mb-4 text-xs font-mono space-y-1">
                    <div class="flex justify-between"><span>Mesa:</span> <span id="t-mesa" class="font-bold"></span></div>
                    <div class="flex justify-between"><span>Llegada:</span> <span id="t-start"></span></div>
                    <div class="flex justify-between"><span>Cobro:</span> <span id="t-end"></span></div>
                </div>

                <ul id="t-items" class="space-y-2 text-sm font-mono border-b-2 border-slate-800 pb-4 mb-4"></ul>

                <div class="flex justify-between items-end text-xl font-black">
                    <span>TOTAL</span>
                    <span id="t-total"></span>
                </div>

                <div class="mt-8 text-center">
                    <p class="text-[10px] text-slate-400 italic">Gracias por su visita</p>
                </div>
            </div>
            <div class="h-4 w-full ticket-jagged -mt-2 relative z-10"></div>
        </div>
    </div>


    <script>
        const DB = {
            init: () => {
                const keys = ['paco_ings', 'paco_plates', 'paco_tables', 'paco_history'];
                keys.forEach(key => { if (!localStorage.getItem(key)) localStorage.setItem(key, JSON.stringify([])); });
            },
            get: (key) => JSON.parse(localStorage.getItem(key)),
            set: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
            addOrUpdate: (key, item) => {
                let list = DB.get(key);
                const index = list.findIndex(i => i.id == item.id);
                index >= 0 ? list[index] = item : list.push(item);
                DB.set(key, list);
            },
            delete: (key, id) => {
                let list = DB.get(key);
                DB.set(key, list.filter(i => i.id != id));
            }
        };

        DB.init();

        let curRecipe = [];
        let allIngredients = [];
        let activeTableId = null;

        // --- NAVEGACI√ìN ---
        function showSection(id) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('nav-active', 'bg-blue-600', 'text-white');
                b.classList.add('text-slate-400');
            });
            document.getElementById('sec-' + id).classList.remove('hidden');
            const btn = event ? event.currentTarget : document.querySelector(`button[onclick="showSection('${id}')"]`);
            if (btn) { btn.classList.add('nav-active'); btn.classList.remove('text-slate-400'); }

            if (id === 'almacen') loadStock();
            if (id === 'carta') loadPlates();
            if (id === 'mesas') loadTables();
            if (id === 'historial') loadHistory();
        }

        function toggleModal(id, show) {
            const el = document.getElementById(id);
            show ? (el.classList.remove('hidden'), el.classList.add('flex')) : (el.classList.add('hidden'), el.classList.remove('flex'));
        }

        // --- ALMAC√âN ---
        function openIngModal(editData = null) {
            if (editData && typeof editData === 'string') editData = JSON.parse(decodeURIComponent(editData));
            const title = document.getElementById('modal-ing-title');
            if (editData) {
                title.innerText = "Editar Producto";
                document.getElementById('ing-id').value = editData.id;
                document.getElementById('ing-type').value = editData.type;
                document.getElementById('ing-name').value = editData.name;
                document.getElementById('ing-stock').value = editData.stock;
                document.getElementById('ing-unit').value = editData.unit;
                document.getElementById('ing-min-stock').value = editData.min_stock || "";
                const hasSub = (editData.sub_qty && editData.sub_qty > 1) || (editData.unit === 'Kg' || editData.unit === 'Litros');
                document.getElementById('toggle-subunits').checked = hasSub;
                if (hasSub) {
                    document.getElementById('ing-sub-qty').value = editData.sub_qty;
                    document.getElementById('ing-sub-name').value = editData.sub_name;
                }
            } else {
                title.innerText = "Nuevo Producto";
                document.getElementById('ing-id').value = "";
                document.getElementById('ing-name').value = "";
                document.getElementById('ing-stock').value = "";
                document.getElementById('ing-min-stock').value = "";
                document.getElementById('toggle-subunits').checked = false;
                document.getElementById('ing-sub-qty').value = "";
                document.getElementById('ing-sub-name').value = "";
            }
            toggleFormLogic();
            toggleModal('modal-ing', true);
        }

        function toggleFormLogic() {
            const type = document.getElementById('ing-type').value;
            const subBox = document.getElementById('box-subunits');
            type === 'Bebida' ? subBox.classList.add('hidden') : subBox.classList.remove('hidden');
            toggleSubFields();
        }

        function toggleSubFields() {
            const checked = document.getElementById('toggle-subunits').checked;
            const fields = document.getElementById('sub-fields');
            checked ? fields.classList.remove('hidden') : fields.classList.add('hidden');
        }

        function saveIngredient() {
            const id = document.getElementById('ing-id').value;
            const unit = document.getElementById('ing-unit').value;
            const hasSub = document.getElementById('toggle-subunits').checked;
            let subQty = 1; let subName = unit;
            if (unit === "Kg") { subQty = 1000; subName = "gramos"; }
            else if (unit === "Litros") { subQty = 1000; subName = "ml"; }
            else if (hasSub) {
                subQty = parseFloat(document.getElementById('ing-sub-qty').value) || 1;
                subName = document.getElementById('ing-sub-name').value;
            }
            const payload = {
                id: id ? parseInt(id) : Date.now(),
                type: document.getElementById('ing-type').value,
                name: document.getElementById('ing-name').value,
                stock: parseFloat(document.getElementById('ing-stock').value) || 0,
                min_stock: parseFloat(document.getElementById('ing-min-stock').value) || 0,
                unit: unit,
                sub_qty: subQty,
                sub_name: subName
            };
            DB.addOrUpdate('paco_ings', payload);
            toggleModal('modal-ing', false);
            loadStock();
        }

        function deleteIngredient(id) {
            if (!confirm("¬øEliminar este producto?")) return;
            DB.delete('paco_ings', id);
            loadStock();
        }

        // --- L√ìGICA DE ORDENACI√ìN (NUEVO) ---
        function loadStock() {
            allIngredients = DB.get('paco_ings');
            
            // Ordenar seg√∫n selector
            const sortMode = document.getElementById('stock-sort').value;
            allIngredients.sort((a, b) => {
                if(sortMode === 'name') return a.name.localeCompare(b.name);
                if(sortMode === 'stock-asc') return a.stock - b.stock;
                if(sortMode === 'stock-desc') return b.stock - a.stock;
                return 0;
            });

            const renderTable = (listId, type) => {
                const filtered = allIngredients.filter(i => i.type === type);
                document.getElementById(listId).innerHTML = filtered.map(i => {
                    const safeObj = encodeURIComponent(JSON.stringify(i));
                    const isLowStock = i.min_stock > 0 && i.stock <= i.min_stock;
                    const rowClass = isLowStock ? 'bg-red-900/20 border-red-500/50' : 'hover:bg-slate-700/50 border-b border-slate-700/50';
                    const textClass = isLowStock ? 'text-red-400' : 'text-slate-200';
                    const stockColor = isLowStock ? 'text-red-500 animate-pulse' : 'text-emerald-400';
                    const alertIcon = isLowStock ? '<i class="fas fa-exclamation-triangle text-yellow-500 mr-2 animate-bounce"></i>' : '';

                    return `
                    <tr class="${rowClass} transition last:border-0">
                        <td class="p-4">
                            <div class="font-bold ${textClass}">${alertIcon}${i.name}</div>
                            <div class="text-[10px] text-slate-500 italic">${i.sub_qty > 1 ? `1 ${i.unit} = ${i.sub_qty} ${i.sub_name}` : 'Unidad simple'}</div>
                        </td>
                        <td class="p-4 font-mono ${stockColor} font-bold">
                            ${i.stock.toFixed(2)} <span class="text-xs text-slate-500">${i.unit}</span>
                            ${isLowStock ? `<div class="text-[9px] text-red-400 uppercase">M√≠n: ${i.min_stock}</div>` : ''}
                        </td>
                        <td class="p-4 text-right space-x-2">
                            <button onclick='openIngModal("${safeObj}")' class="text-blue-400 hover:text-blue-300 p-2"><i class="fas fa-pen"></i></button>
                            <button onclick="deleteIngredient(${i.id})" class="text-red-400 hover:text-red-300 p-2"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`
                }).join('');
            };
            renderTable('list-cocina', 'Cocina');
            renderTable('list-bebidas', 'Bebida');
        }

        // --- PLATOS ---
        function openPlateModal(plateData = null) {
            if (plateData && typeof plateData === 'string') plateData = JSON.parse(decodeURIComponent(plateData));
            loadIngredientsForRecipe();
            if (plateData) {
                document.getElementById('modal-plate-title').innerText = "Editar Receta";
                document.getElementById('p-id').value = plateData.id;
                document.getElementById('p-name').value = plateData.name;
                document.getElementById('p-price').value = plateData.price;
                curRecipe = plateData.recipe || [];
            } else {
                document.getElementById('modal-plate-title').innerText = "Nueva Receta";
                document.getElementById('p-id').value = "";
                document.getElementById('p-name').value = "";
                document.getElementById('p-price').value = "";
                curRecipe = [];
            }
            renderRecipeList();
            toggleModal('modal-plato', true);
        }

        function loadIngredientsForRecipe() {
            const ings = DB.get('paco_ings').filter(i => i.type === 'Cocina');
            document.getElementById('p-ing-sel').innerHTML = `<option value="">Selecciona ingrediente...</option>` +
                ings.map(i => `<option value='${JSON.stringify(i)}'>${i.name}</option>`).join('');
        }

        function updateRecipeUI() {
            const sel = document.getElementById('p-ing-sel');
            if (!sel.value) return;
            const ing = JSON.parse(sel.value);
            const label = document.getElementById('p-unit-label');
            const displayUnit = ing.sub_name || ing.unit;
            label.innerText = `Cantidad en ${displayUnit}`;
            label.classList.add('text-orange-400');
            document.getElementById('p-ing-cant').focus();
        }

        function addRecipeItem() {
            const sel = document.getElementById('p-ing-sel');
            if (!sel.value) return alert("Selecciona un ingrediente");
            const ing = JSON.parse(sel.value);
            const cantInput = parseFloat(document.getElementById('p-ing-cant').value);
            if (!cantInput || cantInput <= 0) return alert("Cantidad inv√°lida");

            curRecipe.push({
                id: ing.id,
                name: ing.name,
                stock_cost: cantInput / (ing.sub_qty || 1),
                display_qty: cantInput,
                display_unit: ing.sub_name || ing.unit
            });
            renderRecipeList();
            document.getElementById('p-ing-cant').value = "";
            sel.value = "";
        }

        function removeRecipeItem(index) {
            curRecipe.splice(index, 1);
            renderRecipeList();
        }

        function renderRecipeList() {
            const list = document.getElementById('p-recipe-list');
            if (curRecipe.length === 0) { list.innerHTML = ""; document.getElementById('recipe-empty').classList.remove('hidden'); return; }
            document.getElementById('recipe-empty').classList.add('hidden');
            list.innerHTML = curRecipe.map((item, idx) => `
                <li class="flex justify-between items-center bg-slate-800 p-3 rounded-lg border border-slate-700">
                    <div><span class="font-bold text-white block">${item.name}</span><span class="text-xs text-blue-400 font-mono">${item.display_qty} ${item.display_unit}</span></div>
                    <button onclick="removeRecipeItem(${idx})" class="text-red-500 hover:bg-slate-700 p-2"><i class="fas fa-times"></i></button>
                </li>`).join('');
        }

        function savePlate() {
            const payload = {
                id: document.getElementById('p-id').value ? parseInt(document.getElementById('p-id').value) : Date.now(),
                name: document.getElementById('p-name').value,
                price: parseFloat(document.getElementById('p-price').value),
                recipe: curRecipe
            };
            if (!payload.name || !payload.price) return alert("Faltan datos");
            DB.addOrUpdate('paco_plates', payload);
            toggleModal('modal-plato', false);
            loadPlates();
        }

        function deletePlate(id) {
            if (!confirm("¬øBorrar este plato?")) return;
            DB.delete('paco_plates', id);
            loadPlates();
        }

        function loadPlates() {
            const plates = DB.get('paco_plates');
            document.getElementById('grid-platos').innerHTML = plates.map(p => {
                const safeObj = encodeURIComponent(JSON.stringify(p));
                return `
                <div class="bg-[#1e293b] p-6 rounded-2xl border border-slate-700 shadow-lg group hover:border-orange-500/50 transition relative">
                    <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition flex gap-2">
                        <button onclick='openPlateModal("${safeObj}")' class="bg-blue-600 text-white p-2 rounded-lg text-xs"><i class="fas fa-pen"></i></button>
                        <button onclick="deletePlate(${p.id})" class="bg-red-600 text-white p-2 rounded-lg text-xs"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="h-10 w-10 bg-orange-500/20 rounded-full flex items-center justify-center mb-4 text-orange-500"><i class="fas fa-utensils"></i></div>
                    <h4 class="font-black uppercase italic text-lg text-white mb-1 leading-tight">${p.name}</h4>
                    <div class="text-2xl font-black text-emerald-400">${p.price.toFixed(2)}‚Ç¨</div>
                </div>`
            }).join('');
        }

        // --- MESAS Y COMANDAS ACTUALIZADO ---
        
        // Abrir modal para crear o editar mesa
        function openMesaModal(editData = null) {
            const title = document.getElementById('modal-mesa-title');
            const idField = document.getElementById('m-id-edit');
            const numField = document.getElementById('m-num');
            const capField = document.getElementById('m-cap');

            if (editData) {
                // Modo Edici√≥n
                title.innerText = "Editar Mesa " + editData.number;
                idField.value = editData.id;
                numField.value = editData.number;
                capField.value = editData.capacity || 0;
            } else {
                // Modo Creaci√≥n
                title.innerText = "Nueva Mesa";
                idField.value = "";
                numField.value = "";
                capField.value = "";
            }
            toggleModal('modal-mesa-create', true);
        }

        // Guardar mesa (crear o actualizar)
        function saveTable() {
            const id = document.getElementById('m-id-edit').value;
            const num = document.getElementById('m-num').value;
            const cap = document.getElementById('m-cap').value;

            if (!num || !cap) return alert("Por favor, rellena todos los campos");

            const tables = DB.get('paco_tables');
            
            if (id) {
                // Estamos editando
                const idx = tables.findIndex(t => t.id == id);
                if (idx !== -1) {
                    tables[idx].number = num;
                    tables[idx].capacity = cap;
                    DB.set('paco_tables', tables);
                }
            } else {
                // Estamos creando nueva
                const payload = { 
                    id: Date.now(), 
                    number: num, 
                    capacity: cap, 
                    status: 'Libre', 
                    order: [] 
                };
                DB.addOrUpdate('paco_tables', payload);
            }

            toggleModal('modal-mesa-create', false);
            loadTables();
        }

        // Cargar mesas visualmente con capacidad y opciones
        function loadTables() {
            const tables = DB.get('paco_tables');
            document.getElementById('grid-mesas').innerHTML = tables.map(t => {
                const safeObj = encodeURIComponent(JSON.stringify(t));
                return `
                <div class="relative group">
                    <div class="absolute -top-3 -right-3 z-20 flex gap-1 opacity-0 group-hover:opacity-100 transition">
                         <button onclick='event.stopPropagation(); openMesaModal(${JSON.stringify(t)})' 
                            class="bg-blue-600 text-white w-8 h-8 rounded-full border-2 border-slate-800 hover:bg-blue-500 shadow-lg flex items-center justify-center">
                            <i class="fas fa-pen text-[10px]"></i>
                        </button>
                        <button onclick='event.stopPropagation(); deleteTableDirect(${t.id})' 
                            class="bg-red-600 text-white w-8 h-8 rounded-full border-2 border-slate-800 hover:bg-red-500 shadow-lg flex items-center justify-center">
                            <i class="fas fa-trash text-[10px]"></i>
                        </button>
                    </div>

                    <div onclick="openComanda(${t.id})" class="h-32 rounded-3xl cursor-pointer flex flex-col items-center justify-center transition border-b-4 shadow-xl hover:translate-y-1 relative overflow-hidden
                        ${t.status === 'Libre' ? 'bg-emerald-600 border-emerald-800 text-white' : 'bg-red-500 border-red-800 text-white'}">
                        
                        <span class="text-4xl font-black italic uppercase z-10">${t.number}</span>
                        
                        <div class="z-10 flex items-center gap-1 mt-1 bg-black/20 px-2 rounded-full text-[10px] font-bold">
                            <i class="fas fa-users text-[8px]"></i> ${t.capacity || '?'}
                        </div>

                        <span class="text-[9px] font-black uppercase opacity-80 italic z-10 mt-1">${t.status}</span>
                        ${t.order && t.order.length > 0 ? '<i class="fas fa-utensils absolute text-6xl opacity-20 -bottom-2 -right-2"></i>' : ''}
                    </div>
                </div>`;
            }).join('');
        }

        function deleteTableDirect(id) {
            if (!confirm("¬øEliminar esta mesa y su configuraci√≥n?")) return;
            DB.delete('paco_tables', id);
            loadTables();
        }

        function openComanda(id) {
            activeTableId = id;
            const tables = DB.get('paco_tables');
            const table = tables.find(t => t.id === id);
            if (!table) return;

            document.getElementById('comanda-mesa-num').innerText = table.number;
            const statTag = document.getElementById('comanda-status');
            statTag.innerText = table.status;
            statTag.className = `text-xs font-bold uppercase px-2 py-1 rounded ${table.status === 'Libre' ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-red-600'}`;

            const plates = DB.get('paco_plates');
            const drinks = DB.get('paco_ings').filter(i => i.type === 'Bebida');
            const sel = document.getElementById('comanda-select');

            let html = `<option value="">Selecciona...</option>`;
            html += `<optgroup label="PLATOS">` + plates.map(p => `<option value='{"type":"plate","id":${p.id},"name":"${p.name}","price":${p.price}}'>${p.name} - ${p.price}‚Ç¨</option>`).join('') + `</optgroup>`;
            html += `<optgroup label="BEBIDAS">` + drinks.map(d => `<option value='{"type":"drink","id":${d.id},"name":"${d.name}","price":2.50}'>${d.name} - 2.50‚Ç¨</option>`).join('') + `</optgroup>`;
            sel.innerHTML = html;

            renderOrderList(table);
            toggleModal('modal-comanda', true);
        }

        function addToOrder() {
            const sel = document.getElementById('comanda-select');
            if (!sel.value) return;
            const item = JSON.parse(sel.value);
            const tables = DB.get('paco_tables');
            const table = tables.find(t => t.id === activeTableId);
            
            if (!table.order) table.order = [];
            // CAPTURA DE TIEMPO: Si es el primer item, guardamos timestamp
            if (table.order.length === 0) {
                table.startTime = Date.now();
            }

            table.order.push(item);
            table.status = 'Ocupada';
            DB.addOrUpdate('paco_tables', table);
            openComanda(activeTableId);
            loadTables();
        }

        function renderOrderList(table) {
            const list = document.getElementById('comanda-list');
            const empty = document.getElementById('comanda-empty');
            const totalEl = document.getElementById('comanda-total');

            if (!table.order || table.order.length === 0) {
                list.innerHTML = "";
                empty.classList.remove('hidden');
                totalEl.innerText = "0.00‚Ç¨";
                return;
            }

            empty.classList.add('hidden');
            let total = 0;
            list.innerHTML = table.order.map((item, idx) => {
                total += item.price;
                return `
                <li class="flex justify-between items-center bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                    <span class="font-bold text-slate-700">${item.name}</span>
                    <div class="flex items-center gap-3">
                        <span class="font-mono text-slate-500">${item.price.toFixed(2)}‚Ç¨</span>
                        <button onclick="removeFromOrder(${idx})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </li>`;
            }).join('');
            totalEl.innerText = total.toFixed(2) + "‚Ç¨";
        }

        function removeFromOrder(idx) {
            const tables = DB.get('paco_tables');
            const table = tables.find(t => t.id === activeTableId);
            table.order.splice(idx, 1);
            if (table.order.length === 0) {
                table.status = 'Libre';
                delete table.startTime; // Reset tiempo si se vac√≠a
            }
            DB.addOrUpdate('paco_tables', table);
            openComanda(activeTableId);
            loadTables();
        }

        function closeTable() {
            if (!confirm("¬øCobrar mesa y descontar ingredientes del stock?")) return;

            const tables = DB.get('paco_tables');
            const table = tables.find(t => t.id === activeTableId);
            const plates = DB.get('paco_plates');
            const ingredients = DB.get('paco_ings');
            const history = DB.get('paco_history');

            let totalVenta = 0;
            table.order.forEach(item => {
                totalVenta += item.price;
                if (item.type === 'plate') {
                    const originalPlate = plates.find(p => p.id === item.id);
                    if (originalPlate && originalPlate.recipe) {
                        originalPlate.recipe.forEach(recItem => {
                            const ingIdx = ingredients.findIndex(i => i.id === recItem.id);
                            if (ingIdx >= 0) ingredients[ingIdx].stock -= recItem.stock_cost;
                        });
                    }
                } else if (item.type === 'drink') {
                    const ingIdx = ingredients.findIndex(i => i.id === item.id);
                    if (ingIdx >= 0) ingredients[ingIdx].stock -= 1;
                }
            });

            // --- GUARDAR EN HISTORIAL (MEJORADO) ---
            const ticket = {
                id: Date.now(),
                date: new Date().toLocaleDateString(),
                tableName: table.number,
                items: table.order, // Guardamos objeto completo
                total: totalVenta,
                startTime: table.startTime || Date.now(),
                endTime: Date.now()
            };
            history.push(ticket);
            DB.set('paco_history', history);
            // ----------------------------

            DB.set('paco_ings', ingredients);
            table.order = [];
            table.status = 'Libre';
            delete table.startTime;
            DB.addOrUpdate('paco_tables', table);

            toggleModal('modal-comanda', false);
            loadTables();
            loadStock();
            alert("Venta registrada y stock actualizado.");
        }

        function deleteTable() {
            if (!confirm("¬øEliminar esta mesa definitivamente?")) return;
            DB.delete('paco_tables', activeTableId);
            toggleModal('modal-comanda', false);
            loadTables();
        }

        // --- HISTORIAL DETALLADO (NUEVO) ---
        function loadHistory() {
            const history = DB.get('paco_history').reverse();
            const container = document.getElementById('list-historial');

            if (history.length === 0) {
                container.innerHTML = '<tr><td colspan="4" class="p-10 text-center text-slate-500 italic">No hay ventas registradas.</td></tr>';
                return;
            }

            container.innerHTML = history.map(t => {
                // Compatibilidad con registros antiguos que no ten√≠an array de objetos
                const displayItems = Array.isArray(t.items) ? t.items.map(i => i.name).join(', ') : t.items;
                const dateDisplay = new Date(t.endTime || t.id).toLocaleString();

                return `
                <tr onclick="viewTicket(${t.id})" class="hover:bg-slate-700/50 transition cursor-pointer group">
                    <td class="p-4 text-slate-400 font-mono text-xs group-hover:text-blue-300">
                        <i class="fas fa-search mr-2 opacity-0 group-hover:opacity-100"></i>${dateDisplay}
                    </td>
                    <td class="p-4 font-bold text-white">Mesa ${t.tableName}</td>
                    <td class="p-4 text-slate-400 text-xs max-w-xs truncate">${displayItems}</td>
                    <td class="p-4 text-right font-black text-emerald-400">${t.total.toFixed(2)}‚Ç¨</td>
                </tr> `
            }).join('');
        }

        function viewTicket(id) {
            const history = DB.get('paco_history');
            const t = history.find(i => i.id === id);
            if(!t) return;

            document.getElementById('t-mesa').innerText = t.tableName;
            
            // Formateo de fechas
            const start = t.startTime ? new Date(t.startTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : "N/A";
            const end = t.endTime ? new Date(t.endTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : new Date(t.id).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            document.getElementById('t-start').innerText = start;
            document.getElementById('t-end').innerText = end;

            // Lista items
            const list = document.getElementById('t-items');
            if(Array.isArray(t.items)) {
                list.innerHTML = t.items.map(i => `
                    <li class="flex justify-between border-b border-dashed border-slate-300 pb-1 last:border-0">
                        <span>${i.name}</span>
                        <span>${i.price.toFixed(2)}</span>
                    </li>
                `).join('');
            } else {
                // Fallback para datos antiguos
                list.innerHTML = `<li class="text-xs italic text-slate-400">${t.items}</li>`;
            }

            document.getElementById('t-total').innerText = t.total.toFixed(2) + "‚Ç¨";
            toggleModal('modal-ticket', true);
        }

        function clearHistory() {
            if (confirm("¬øSeguro que quieres borrar todo el historial?")) {
                DB.set('paco_history', []);
                loadHistory();
            }
        }

        window.onload = () => showSection('almacen');
    </script>
</body>
</html>